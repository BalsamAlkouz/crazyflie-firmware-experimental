# -*- coding: utf-8 -*-
#
#     ||          ____  _ __
#  +------+      / __ )(_) /_______________ _____  ___
#  | 0xBC |     / __  / / __/ ___/ ___/ __ `/_  / / _ \
#  +------+    / /_/ / / /_/ /__/ /  / /_/ / / /_/  __/
#   ||  ||    /_____/_/\__/\___/_/   \__,_/ /___/\___/
#
#  Copyright (C) 2019 Bitcraze AB
#
#  Crazyflie Nano Quadcopter Client
#
#  This program is free software; you can redistribute it and/or
#  modify it under the terms of the GNU General Public License
#  as published by the Free Software Foundation; either version 2
#  of the License, or (at your option) any later version.
#
#  This program is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#  GNU General Public License for more details.
#  You should have received a copy of the GNU General Public License
#  along with this program; if not, write to the Free Software
#  Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
#  MA  02110-1301, USA.
"""
Simple example that connects to a crazyflie and uses the high level commander to
go to a set of points.
"""
import time

import cflib.crtp
from cflib.crazyflie import Crazyflie
from cflib.crazyflie.log import LogConfig
from cflib.crazyflie.syncCrazyflie import SyncCrazyflie
from cflib.crazyflie.syncLogger import SyncLogger
from cflib.crazyflie.mem import MemoryElement
from cflib.crazyflie.mem import Poly4D
from cflib.crazyflie.swarm import Swarm, CachedCfFactory

from utils.util import Utils, Uploader


uris = {
    'radio://0/30/2M/E7E7E7E7E7',
    # 'radio://0/30/2M/E7E7E7E713',
    # 'radio://0/30/2M/E7E7E7E711',
    # 'radio://0/30/2M/E7E7E7E722',
}


#  duration   x * 8    y * 8    z * 8    YAW * 8
sequence = [
[0.55,3.850187593955523e-11,-6.126680000712511e-07,0.03401153508256036,-0.0003930116220986338,-0.1361701207374106,-0.01347556623110199,0.13052917793075702,-0.04578980321039387,5.1303311273956524e-11,-6.894694833423713e-07,2.77364664888298e-05,0.0966502214513382,0.003058298047113766,-0.14597702960555933,0.025898651836380876,0.031816204956539404,0.9935094937573055,0.3354737430677826,0.029057160592996817,-0.012668324162250442,-0.0005486332886864698,0.00014350746158573577,4.164696833263305e-06,-8.019385760357137e-07,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,],
[0.55,-6.914789349279782e-11,-0.0291937091575539,-0.10559495462082444,-0.05347086572902417,0.14298644900225546,0.13154711964787244,-0.10576667456487523,-0.004894549656634545,0.010222252124903143,0.036959027444521536,-0.008851229203248604,-0.15229948402423618,-0.1047381893385876,0.101347754562112,0.1050308201284748,-0.06287119477128597,1.1846592732952834,0.35564176146138543,0.007402285626837008,-0.013429918471742934,-0.00013976442616143463,0.00015214424892597548,1.0560358084852783e-06,-8.232518552443779e-07,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,],
[0.55,-0.04019237884462189,-0.07140003156906768,0.13449310653650642,0.293788709521075,0.009789196773300356,-0.21053548856665216,-0.05387360519407717,0.07164061868152923,-7.889584824031108e-11,-0.1147880173867247,-0.20396423865610033,0.07270282032680737,0.2794859692635279,0.07498870791556085,-0.17675426223668056,0.027076140221851074,1.3802619153775324,0.3515733815371129,-0.014757042869852561,-0.013276286055414336,0.00027862928891240433,0.00015041224619785417,-2.123983024990528e-06,-7.888166190807983e-07,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,],
[0.55,7.9882893561602e-11,0.25094912456349616,0.2884318844281399,-0.27327230852216894,-0.39713804601306946,0.019843843314875327,0.23402372804393057,-0.061917114987157705,-0.08786796558968524,-0.10097530219100948,0.3343518106101174,0.41521843121551166,-0.14220624001760684,-0.30664667217460195,0.019456187248935435,0.07150045317531198,1.566987423194795,0.32354585666361074,-0.03591070328357547,-0.012217896665663908,0.0006780347648274709,0.00013843024405992617,-5.159775693037814e-06,-7.003205046354669e-07,5.880646059865974e-16,2.8559933214452022,1.5134683971805164e-12,-1.5526171310282385e-11,8.100072125686928e-11,-2.255694444617964e-10,3.1879716250404646e-10,-1.7953687179001127e-10,],
[0.55,0.14999999991104954,0.12366933349288824,-0.5948073010230659,-0.5083134142515284,0.34088988322795644,0.38313148698359717,-0.10996125293404707,-0.06246025035101174,7.204181564705014e-11,0.4283978762506362,0.35324156146703717,-0.5345691196935451,-0.48792488465088946,0.14648785240477835,0.27367225251332855,-0.09725401977105734,1.732110761967818,0.27346921634334326,-0.05461710861369336,-0.010326877817694199,0.0010312333621223773,0.00011701420622534727,-7.843547386381955e-06,-5.643373271771315e-07,1.5707963267948974,2.8559933214452307,6.529588012707325e-13,-6.6113310669694056e-12,3.735546371206965e-11,-1.133369792165579e-10,1.730159444822708e-10,-1.0502289217996955e-10,],
[0.55,-5.590676998044823e-11,-0.6350414332686115,-0.39397659738532415,0.8387863079711302,0.5456595121593142,-0.29631273941726766,-0.29299785425225766,0.13067870293447323,0.22235428634775545,0.13793556474516933,-0.8981099665276765,-0.5667293893727312,0.5727217708692539,0.4347776193715169,-0.21147382134117193,-0.0451360850204587,1.8643790490384384,0.2047561008582895,-0.06960144824580641,-0.007732099359700447,0.0013141553409779752,8.762323321471909e-05,-9.991967411518235e-06,-3.9034477306289753e-07,-3.1415926535897936,2.855993321445341,-2.1430860701715986e-12,2.4295967045493487e-11,-1.3475107474130273e-10,3.8711169298502755e-10,-5.550431959213249e-10,3.1533004572859183e-10,],
[0.55,-0.29999999985025316,-0.1428017758640592,1.2235902317006804,0.5864854044162942,-0.8219029429395693,-0.45806547072073106,0.3170759786441125,0.02070857043935285,-3.257760523671644e-11,-0.8567973787012485,-0.4078609668033115,1.1651919747172554,0.5664074090922147,-0.45910818595020153,-0.29068352533008507,0.15991332747539252,1.9547784192264734,0.12208919547533723,-0.07984256420532546,-0.004610391070863488,0.001507519607336814,5.226143446030876e-05,-1.1460231321639676e-05,-1.8931466937781382e-07,-1.5707963267948954,2.8559933214452395,6.168912006671772e-13,-6.5264968953702826e-12,3.494666727223225e-11,-1.0168726757533016e-10,1.511127002485842e-10,-8.867543746960324e-11,],
[0.55,3.644005964852569e-12,1.0785534113363313,0.39394847289100987,-1.4915421131679771,-0.5487546404639576,0.6237799510233817,0.2668869839824612,-0.18296560238859835,-0.3776457133589559,-0.13793634260360485,1.5490671543521493,0.56623511960613,-1.0714521143646134,-0.4514080123975992,0.41957111224473154,-0.009157598576932753,1.99714830484563,0.031102113182726432,-0.08464254136172276,-0.00117449223445721,0.0015981488219055132,1.3338341996900151e-05,-1.2147847184388398e-05,2.4820806199121715e-08,5.880646059865974e-16,2.8559933214452022,1.5134683971805164e-12,-1.5526171310282385e-11,8.100072125686928e-11,-2.255694444617964e-10,3.1879716250404646e-10,-1.7953687179001127e-10,],
[0.55,0.44999999981385436,0.12367083619996877,-1.8523600200789185,-0.5073585583894045,1.304362921509876,0.41525893922630175,-0.5119743482743735,0.042427092047606384,-2.892218686882008e-11,1.2851972240189782,0.3531872291154821,-1.7955965006834258,-0.4939042134391904,0.7791059264872356,0.2232299243717698,-0.1982645527397727,1.9886012682105123,-0.06200452672463933,-0.0836742692022235,0.0023414463028527434,0.0015798668500087481,-2.6493767549635133e-05,-1.2007569974895114e-05,2.3724471752438307e-07,1.5707963267948974,2.8559933214452307,6.529588012707325e-13,-6.6113310669694056e-12,3.735546371206965e-11,-1.133369792165579e-10,1.730159444822708e-10,-1.0502289217996955e-10,],
[0.55,6.290181931423253e-11,-1.462646382409883,-0.2883550468803919,2.0566343332492703,0.40559409384125195,-0.9145009033819449,-0.162687503606712,0.20476758072727128,0.5121320341641588,0.10097742733971071,-2.1127999212970554,-0.4138680611170597,1.504762877803337,0.35208175066787295,-0.5879885586526423,0.07683264880788725,1.9297197757431537,-0.1508856606029833,-0.07700373387608969,0.005697819151369112,0.0014539195479592966,-6.452037522059694e-05,-1.1048942288722835e-05,4.3345033804015827e-07,-3.1415926535897936,2.855993321445341,-2.1430860701715986e-12,2.4295967045493487e-11,-1.3475107474130273e-10,3.8711169298502755e-10,-5.550431959213249e-10,3.1533004572859183e-10,],
[0.55,-0.5598076209469377,-0.07140263433404061,2.3126383091363274,0.2921348506694856,-1.6589950573408658,-0.2661818679171394,0.6424335008817387,-0.11002958721884454,9.59792333863483e-11,-1.5988080196133576,-0.2038701322631343,2.256866313941571,0.2898424704955125,-1.0207379381182624,-0.08938558712311834,0.20203151546162398,1.824516503848941,-0.22948418606174736,-0.06508552133603857,0.008665894988206645,0.0012288903072836684,-9.81507899823963e-05,-9.33627939558364e-06,5.995237265085689e-07,-1.5707963267948954,2.8559933214452395,6.168912006671772e-13,-6.5264968953702826e-12,3.494666727223225e-11,-1.0168726757533016e-10,1.511127002485842e-10,-8.867543746960324e-11,],
[0.55,-1.2589996712175914e-10,1.6844029450716744,0.10548999257829261,-2.3826469641889414,-0.1545376251719916,1.0905771521415226,0.008319579678697649,-0.1902428154303405,-0.5897777477105768,-0.03696193045164436,2.438256527714338,0.15045484416180427,-1.7565487919522957,-0.16341322606457417,0.6715988421680035,-0.1397555908095126,1.6801608816508362,-0.29244374348078345,-0.048731838081280496,0.011043404465794078,0.0009201138707370952,-0.00012509137309051654,-6.98882859821916e-06,7.255705384444949e-07,5.880646059865974e-16,2.8559933214452022,1.5134683971805164e-12,-1.5526171310282385e-11,8.100072125686928e-11,-2.255694444617964e-10,3.1879716250404646e-10,-1.7953687179001127e-10,],
[0.55,0.599999999844111,2.3927461199176896e-06,-2.481093903027929,0.0015167000881265607,1.7907759559047671,0.05077933802765024,-0.6734970124229926,0.16398488140108017,-1.5062477045440957e-10,1.7135980060671805,-8.092823604441072e-05,-2.4254045405345535,-0.008900359498706172,1.1192591184806375,-0.07498600434828781,-0.17020486102821322,1.5064905062426943,-0.3354737430680004,-0.02905716058711752,0.01266832409942846,0.0005486336214197331,-0.00014350838816439435,-4.163397281575673e-06,8.012144408180493e-07,1.5707963267948974,2.8559933214452307,6.529588012707325e-13,-6.6113310669694056e-12,3.735546371206965e-11,-1.133369792165579e-10,1.730159444822708e-10,-1.0502289217996955e-10,],
[0.55,1.684693232220209e-10,-1.6844036074401372,0.10564814639030133,2.382225184812049,-0.1371443875443772,-1.1048292085539262,0.15485402713767688,0.14328320568543249,0.5897777477577101,-0.036957247366434416,-2.4382311387412816,0.15342317248213602,1.7593440245442504,-0.0640439828605625,-0.6479986545014156,0.1810662729022063,1.3153407267047164,-0.35564176146143317,-0.007402285625290788,0.013429918453644583,0.00013976452691017729,-0.00015214453409905315,-1.0556372524809971e-06,8.230319724741893e-07,-3.1415926535897936,2.855993321445341,-2.1430860701715986e-12,2.4295967045493487e-11,-1.3475107474130273e-10,3.8711169298502755e-10,-5.550431959213249e-10,3.1533004572859183e-10,],
[0.55,-0.5598076210379913,0.07139825149093751,2.312589261409018,-0.2949123979877578,-1.664395031940718,0.1732317167773424,0.5968414396687439,-0.18983569685936832,1.7821749684805822e-10,-1.5988092992109875,0.20401743042608061,2.2560514987516793,-0.27364390778620523,-1.0482707968640608,0.22584161485398388,0.11131251578997216,1.1197380846224676,-0.35157338153727025,0.014757042874078417,0.01327628601126262,-0.0002786290612783305,-0.00015041286122726384,2.1248181968014714e-06,7.883661730449382e-07,-1.5707963267948954,2.8559933214452395,6.168912006671772e-13,-6.5264968953702826e-12,3.494666727223225e-11,-1.0168726757533016e-10,1.511127002485842e-10,-8.867543746960324e-11,],
[0.55,-1.7920446674128632e-10,1.46264819203419,-0.28848507619727815,-2.055482010566442,0.39129598459397036,0.9534382454598684,-0.2831110804015371,-0.07647154117811078,-0.5121320342929279,0.10097352211287218,2.1127305573355013,-0.41634211968270723,-1.512399595147905,0.26934290037938374,0.5235116472364011,-0.18969553136044268,0.9330125768052053,-0.323545856663662,0.035910703284446496,0.012217896658278276,-0.0006780347318851087,-0.0001384303182401544,5.159853956484018e-06,7.002903521354271e-07,5.880646059865974e-16,2.8559933214452022,1.5134683971805164e-12,-1.5526171310282385e-11,8.100072125686928e-11,-2.255694444617964e-10,3.1879716250404646e-10,-1.7953687179001127e-10,],
[0.55,0.44999999997156387,-0.12366755341480644,-1.8522750669211798,0.5094371027057395,1.3137159519994732,-0.3458277153472856,-0.43300658134246156,0.18065532842608076,-1.7136306846318046e-10,1.2851994403470555,-0.3532947532366572,-1.7941851993871079,0.4820828231779135,0.8267942365473523,-0.3227596051541976,-0.041134636218383924,0.7678892380321827,-0.2734692163433071,0.05461710861295748,0.010326877824302916,-0.0010312333926013044,-0.00011701412775450709,7.843440700494665e-06,5.643958798156053e-07,1.5707963267948974,2.8559933214452307,6.529588012707325e-13,-6.6113310669694056e-12,3.735546371206965e-11,-1.133369792165579e-10,1.730159444822708e-10,-1.0502289217996955e-10,],
[0.55,1.552282992747142e-10,-1.078555883329102,0.39402978915538633,1.4899680111058198,-0.5398174506708434,-0.6769693495683178,0.34208520692746786,0.007709953042621317,0.37764571353485765,-0.1379337846670127,-1.5489724014186188,0.5678530778486656,1.0818840642444454,-0.39747384742154546,-0.3314940133713574,0.16333116333603787,0.6356209509615618,-0.20475610085843485,0.06960144824987503,0.007732099315385301,-0.0013141551039197146,-8.762389636640218e-05,9.992898983409306e-06,3.8982572949542577e-07,-3.1415926535897936,2.855993321445341,-2.1430860701715986e-12,2.4295967045493487e-11,-1.3475107474130273e-10,3.8711169298502755e-10,-5.550431959213249e-10,3.1533004572859183e-10,],
[0.55,-0.30000000003236,0.1427999957859846,1.223492136243694,-0.5876090928735308,-0.832702892267373,0.42076169902052163,0.2258918557271966,-0.13890364856856685,1.3189905005155208e-10,-0.8567999378964536,0.4079141585730845,1.1635623443629897,-0.5605653476224535,-0.5141739029806641,0.3397708779259781,-0.021524671452951914,0.5452215807735272,-0.12208919547551565,0.07984256421017126,0.004610391017873248,-0.001507519320225195,-5.226225046602649e-05,1.1461396929554777e-05,1.8865400529153755e-07,-1.5707963267948954,2.8559933214452395,6.168912006671772e-13,-6.5264968953702826e-12,3.494666727223225e-11,-1.0168726757533016e-10,1.511127002485842e-10,-8.867543746960324e-11,],
[0.55,-1.0296553032200898e-10,0.635043905261388,-0.39400166466124864,-0.8372122059066925,0.5429125789610327,0.34950213801008395,-0.3159743367365601,0.04457694646211291,-0.2223542865236574,0.1379345625254773,0.8980152135933294,-0.5673588080734114,-0.5831537207941083,0.41410424057128303,0.12339672229618608,-0.10903747964402184,0.5028516951543696,-0.031102113182877554,0.08464254136561536,0.0011744921937388315,-0.0015981486090798755,-1.3338926691903501e-05,1.214865564750805e-05,-2.5265190251867046e-08,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,],
[0.55,0.15000000006875855,-0.12366905612178425,-0.5947223478682725,0.508482246875678,0.3502429135476773,-0.3779551671190334,-0.030993486658894998,0.07576798639096927,-7.039917511228842e-11,0.42840009257874945,-0.3532404208860858,-0.5331578183871327,0.4880621519155216,0.19417616259904824,-0.2723172771918514,0.059875896845355464,0.5113987317894879,0.06200452672451641,0.0836742692053459,-0.002341446334146096,-0.0015798666929345442,2.649334962011429e-05,1.2008133990464477e-05,-2.3754945617776116e-07,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,],
[0.55,3.641965196899606e-11,-0.2509509341877963,0.2884082386494212,0.27211998583975966,-0.399752032421553,-0.058781185400076895,0.21177485598066098,-0.06637892457403172,0.08786796571845412,-0.10097564726160385,-0.33428244664777856,0.4149917495765946,0.14984295739993805,-0.31477797897290105,0.04502072430390681,0.041362429302366735,0.5702802242568455,0.1508856606029564,0.07700373387679177,-0.005697819160320804,-0.0014539194952593306,6.452022275912104e-05,1.104915654383949e-05,-4.335682511855074e-07,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,],
[0.55,-0.04019237893567551,0.07140085425594381,0.13444405880830554,-0.2932585391269532,0.004389222126356528,0.228878096254524,-0.09946566657943025,-0.008165490865310309,3.3424711410217572e-12,-0.11478929698434732,0.20392332403281357,0.07188800514049802,-0.2840004090378135,0.04745584922503263,0.13847293966296587,-0.06364285940719684,0.675483496151059,0.22948418606163212,0.06508552134013319,-0.008665895039631501,-0.0012288900072620506,9.814990278312222e-05,9.337573038473718e-06,-6.002640131540521e-07,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,],
[0.55,2.6578199723384452e-11,0.02919437152602349,-0.10554318434785101,0.053892645105913156,0.14869556371813203,-0.11729506325660154,-0.057406932208945494,0.05185415937111979,-0.010222252172035918,0.036960150373508985,0.008825840231354154,-0.15157853263097595,0.10194295680127914,0.12610945422186692,-0.12863100760939658,0.021560512580931897,0.8198391183491641,0.29244374348080493,0.048731838081606305,-0.011043404476109273,-0.0009201137916167518,0.0001250911076130313,6.98924444390766e-06,-7.258205202528438e-07,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,]]


def upload_trajectory(scf):
    trajectory_id = 1
    trajectory_mem = scf.cf.mem.get_mems(MemoryElement.TYPE_TRAJ)[0]

    total_duration = 0
    for row in sequence:
        duration = row[0]
        x = Poly4D.Poly(row[1:9])
        y = Poly4D.Poly(row[9:17])
        z = Poly4D.Poly(row[17:25])
        yaw = Poly4D.Poly(row[25:33])
        trajectory_mem.poly4Ds.append(Poly4D(duration, x, y, z, yaw))
        total_duration += duration

    Uploader().upload(trajectory_mem)
    scf.cf.high_level_commander.define_trajectory(trajectory_id, 0, len(trajectory_mem.poly4Ds))
    return total_duration


def run_sequence(scf):
    duration = 0.55 * len(sequence)
    trajectory_id = 1
    commander = scf.cf.high_level_commander

    commander.takeoff(1.0, 2.0)
    time.sleep(3.0)
    relative = True
    commander.start_trajectory(trajectory_id, 1.0, relative)
    time.sleep(duration)
    commander.land(0.0, 2.0)
    time.sleep(2)
    commander.stop()


if __name__ == '__main__':
    cflib.crtp.init_drivers(enable_debug_driver=False)
    factory = CachedCfFactory(rw_cache='./cache')
    with Swarm(uris, factory=factory) as swarm:
        swarm.parallel_safe(Utils().reset_estimator)
        swarm.parallel_safe(Utils().activate_high_level_commander)
        swarm.parallel_safe(Utils().activate_pid_controller)
        swarm.parallel_safe(upload_trajectory)
        swarm.parallel_safe(run_sequence)



