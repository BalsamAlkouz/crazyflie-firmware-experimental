#include <float.h>
#include <math.h>

#include "FreeRTOS.h"
#include "timers.h"
#include "deck_digital.h"
#include "deck_constants.h"
#include "sensors.h"
#include "estimator_kalman.h"
#include "crtp_commander_high_level.h"
#include "commander.h"
#include "pm.h"
#include "stabilizer.h"
#include "ledseq.h"

#define DEBUG_MODULE "APP"
#include "debug.h"



static xTimerHandle timer;
static bool isInit = false;

static void appTimer(xTimerHandle timer);

#define LED_LOCK         LED_GREEN_R
#define LOCK_LENGTH 50
#define LOCK_THRESHOLD 0.001f
static uint32_t lockWriteIndex;
static float lockData[LOCK_LENGTH][3];
static void resetLockData();
static bool hasLock();

static bool hasButtonBeenPressed = false;

// duration, x0-x7, y0-y7, z0-z7, yaw0-yaw7
static float sequence[] = {
0.375, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.999999999999999, 0.53333333333335853, -5.1943464497897703e-13, 3.0526206318380912e-12, 7.4776942112130583e-12, -1.3664744849582766e-10, 4.7038777693818093e-10, -5.2171039881506561e-10, 0, 0, 0, 0, 0, 0, 0, 0,
0.375, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.1999999999999993, 0.53333333333337207, -8.0859090567742795e-13, 4.8667065277363849e-12, 8.2460585514821688e-12, -1.7925595692324601e-10, 6.0803975870810505e-10, -6.6115692828558184e-10, 0, 0, 0, 0, 0, 0, 0, 0,
0.375, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.3999999999999999, 0.53333333333338639, -2.1073320196152126e-12, 3.0484975673400625e-11, -2.1303054456623891e-10, 7.7593299580240979e-10, -1.416959203731171e-09, 1.0208734732132567e-09, 0, 0, 0, 0, 0, 0, 0, 0,
0.375, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.5999999999999985, 0.53333333333343291, -2.8257541086944273e-12, 3.8545544517739142e-11, -2.8154030859976456e-10, 1.1252819308470704e-09, -2.3130801912726007e-09, 1.9029941807842089e-09, 0, 0, 0, 0, 0, 0, 0, 0,
0.375, 2.8131958339343128e-10, -6.9796813927476918e-06, 0.43907506218881315, -0.0098183335636848005, -3.8939945202367308, -0.75160192552878746, 9.8972957378980251, -5.914724743590166, 5.2973316304142504e-10, -1.0539991553371599e-05, 0.00062267439724221312, 1.8237439193775469, 0.14834491088627122, -6.9151798042012524, 2.7260552615336051, 2.9636784130368379, 1.8000000000000935, -2.0314455665862202e-09, 0.2193246638086577, -2.7227056711356512e-06, -0.080141560822023505, -0.0001892151869939386, 0.012381290075693399, -0.0012098008588503578, 0, 0, 0, 0, 0, 0, 0, 0,
0.375, -5.9133831181429191e-10, -0.24536083797685185, -1.2414541536667256, -0.56449878306912982, 4.3424888045621035, 4.8357507624229843, -10.134717985082004, 2.6889484524653984, 0.058578643552213615, 0.2961954249481738, -0.20391895961339535, -2.8113746808782847, -2.1172291439105648, 5.892351628894712, 4.4282475467920861, -6.5810716382476544, 1.8292893218813862, 0.14809609697792908, 0.15508592906117441, -0.10827167705531156, -0.056675226077969584, 0.023650784987607518, 0.0086369288742763929, -0.0031742639821246039, 0, 0, 0, 0, 0, 0, 0, 0,
0.375, -0.19999999939809987, -0.41889107654270574, 1.7553094261918483, 3.9653736265718704, -2.3947703804434601, -9.1340797589844911, 4.6901195485838763, 3.0553877909260279, -2.8715168678866108e-10, -0.83775084223518381, -1.755036284613454, 2.4600391623758093, 6.294829964704217, -1.3661703228346105, -11.511194251986275, 7.1609180570171729, 1.8999999999999639, 0.20943951091189023, -3.95875521954321e-08, -0.15311655155156248, -9.3114473484538713e-06, 0.03363647163014729, -0.00016681902185535747, -0.0032792937192066131, 0, 0, 0, 0, 0, 0, 0, 0,
0.375, -2.0463831008168809e-10, 1.4301454425031788, 1.2405196203209667, -5.4781366084235046, -4.5650235963344219, 8.0575821926842046, 6.0491629332302317, -7.832611256698951, -0.34142135557364955, -0.29620652644235107, 3.3063128427620554, 2.7958182392076538, -6.9989359247690093, -7.0746220921270169, 12.116389771440227, -2.5970290180750499, 1.9707106781185624, 0.14809609985042468, -0.15508598504497043, -0.10826782678715227, 0.05666205775095421, 0.023918369398789888, -0.0088728469860457817, -0.0014633571265056662, 0, 0, 0, 0, 0, 0, 0, 0,
0.375, 0.39999999992174173, 1.7405208463408809e-06, -3.5092973809946209, 0.0023634636654587104, 5.1042152364927578, 0.16877907238447179, -3.6030590040437804, 1.150344937671506, -6.6214580190261988e-11, 1.6755173762288609, -7.628093753131103e-05, -4.8980890843676548, -0.018021898879107576, 4.403566721054105, -0.32573684146155513, -1.346880871594037, 1.9999999999999991, -0.22222222222221885, -8.5192613229773559e-13, 1.7654891761317278e-11, -1.4423756512080781e-10, 5.6543221347073291e-10, -1.0644647508925903e-09, 7.6938408548657947e-10, 0, 0, 0, 0, 0, 0, 0, 0,
0.375, 6.6214601264057594e-11, -1.6755173762288662, 7.6280937667406768e-05, 4.898089084366128, 0.018021898887754659, -4.4035667210796836, 0.3257368414983392, 1.3468808715752187, 0.39999999992174173, 1.7405208491090818e-06, -3.5092973809948118, 0.002363463669372819, 5.1042152364557491, 0.16877907256123678, -3.6030590044571396, 1.1503449380473527, 1.9166666666666656, -0.22222222222225788, 1.4852821839673571e-12, -2.1427840388108986e-11, 1.5403906106224802e-10, -5.9343073316806952e-10, 1.1694490853142454e-09, -9.2756223831880679e-10, 0, 0, 0, 0, 0, 0, 0, 0,
0.375, -0.39999999992174162, -1.7405208676746328e-06, 3.5092973809956334, -0.0023634636821481649, -5.1042152363602655, -0.16877907293329453, 3.6030590051844271, -1.1503449386101685, 6.6214602421810947e-11, -1.675517376228868, 7.6280937727953523e-05, 4.8980890843654716, 0.018021898890737333, -4.4035667210848484, 0.32573684149712073, 1.3468808715843241, 1.8333333333333326, -0.22222222222208987, -4.7669543626644346e-12, 6.7707239133701953e-11, -4.8405263359945299e-10, 1.8426087090991579e-09, -3.5619590804215482e-09, 2.7514673426869022e-09, 0, 0, 0, 0, 0, 0, 0, 0,
0.375, -6.6214605923043568e-11, 1.6755173762288589, -7.6280937403257808e-05, -4.8980890843701941, -0.018021898856322511, 4.4035667209525009, -0.32573684124042285, -1.3468808717814833, -0.3999999999217419, -1.740520842993595e-06, 3.5092973809946266, -0.0023634636666167784, -5.1042152364769411, -0.16877907247383406, 3.6030590042734252, -1.1503449378932502, 1.7499999999999998, -0.22222222222226687, 1.719408684554518e-12, -2.618734251250676e-11, 1.9794107702165415e-10, -8.0285469170343824e-10, 1.6667086366840669e-09, -1.381283781969143e-09, 0, 0, 0, 0, 0, 0, 0, 0,
0.375, 0.39999999992174173, 1.7405208463408809e-06, -3.5092973809946209, 0.0023634636654587104, 5.1042152364927578, 0.16877907238447179, -3.6030590040437804, 1.150344937671506, -6.6214580190261988e-11, 1.6755173762288609, -7.628093753131103e-05, -4.8980890843676548, -0.018021898879107576, 4.403566721054105, -0.32573684146155513, -1.346880871594037, 1.6666666666666647, -0.22222222222220123, -6.30653963419208e-13, 9.5142500799875386e-12, -7.1486113044883546e-11, 2.8346660466220242e-10, -5.7023486036555173e-10, 4.5580283513497089e-10, 0, 0, 0, 0, 0, 0, 0, 0,
0.375, 6.6214601264057594e-11, -1.6755173762288662, 7.6280937667406768e-05, 4.898089084366128, 0.018021898887754659, -4.4035667210796836, 0.3257368414983392, 1.3468808715752187, 0.39999999992174173, 1.7405208491090818e-06, -3.5092973809948118, 0.002363463669372819, 5.1042152364557491, 0.16877907256123678, -3.6030590044571396, 1.1503449380473527, 1.5833333333333321, -0.22222222222217194, -1.3829483280356106e-12, 1.6230311420173339e-11, -9.0308983594275397e-11, 2.4613484022616236e-10, -2.995412502821124e-10, 1.0857403911510341e-10, 0, 0, 0, 0, 0, 0, 0, 0,
0.375, -0.39999999992174162, -1.7405208676746328e-06, 3.5092973809956334, -0.0023634636821481649, -5.1042152363602655, -0.16877907293329453, 3.6030590051844271, -1.1503449386101685, 6.6214602421810947e-11, -1.675517376228868, 7.6280937727953523e-05, 4.8980890843654716, 0.018021898890737333, -4.4035667210848484, 0.32573684149712073, 1.3468808715843241, 1.4999999999999991, -0.2222222222221488, -2.149923000335998e-12, 2.7210646753397589e-11, -1.7820686122472847e-10, 6.3535220980180257e-10, -1.1723470217725595e-09, 8.7483618737473112e-10, 0, 0, 0, 0, 0, 0, 0, 0,
0.375, -6.6214605923043568e-11, 1.6755173762288589, -7.6280937403257808e-05, -4.8980890843701941, -0.018021898856322511, 4.4035667209525009, -0.32573684124042285, -1.3468808717814833, -0.3999999999217419, -1.740520842993595e-06, 3.5092973809946266, -0.0023634636666167784, -5.1042152364769411, -0.16877907247383406, 3.6030590042734252, -1.1503449378932502, 1.4166666666666652, -0.22222222222220986, -6.5192696571415466e-13, 1.1619217364256816e-11, -9.3192784068593404e-11, 3.779585595513954e-10, -7.5669072658117613e-10, 5.9282119120674676e-10, 0, 0, 0, 0, 0, 0, 0, 0,
0.375, 0.39999999992174173, 1.7405208463408809e-06, -3.5092973809946209, 0.0023634636654587104, 5.1042152364927578, 0.16877907238447179, -3.6030590040437804, 1.150344937671506, -6.6214580190261988e-11, 1.6755173762288609, -7.628093753131103e-05, -4.8980890843676548, -0.018021898879107576, 4.403566721054105, -0.32573684146155513, -1.346880871594037, 1.3333333333333333, -0.22222222222215371, -2.2373724608092634e-12, 2.829365149884517e-11, -1.8111941861732161e-10, 6.2462738696251741e-10, -1.1070775892682556e-09, 7.8950323650471365e-10, 0, 0, 0, 0, 0, 0, 0, 0,
0.375, 6.6214601264057594e-11, -1.6755173762288662, 7.6280937667406768e-05, 4.898089084366128, 0.018021898887754659, -4.4035667210796836, 0.3257368414983392, 1.3468808715752187, 0.39999999992174173, 1.7405208491090818e-06, -3.5092973809948118, 0.002363463669372819, 5.1042152364557491, 0.16877907256123678, -3.6030590044571396, 1.1503449380473527, 1.2499999999999993, -0.22222222222212068, -3.6452723056681053e-12, 5.1757803393090595e-11, -3.7079071825338794e-10, 1.4247178465374281e-09, -2.8025021417665267e-09, 2.2138003758229712e-09, 0, 0, 0, 0, 0, 0, 0, 0,
0.375, -0.39999999992174162, -1.7405208676746328e-06, 3.5092973809956334, -0.0023634636821481649, -5.1042152363602655, -0.16877907293329453, 3.6030590051844271, -1.1503449386101685, 6.6214602421810947e-11, -1.675517376228868, 7.6280937727953523e-05, 4.8980890843654716, 0.018021898890737333, -4.4035667210848484, 0.32573684149712073, 1.3468808715843241, 1.1666666666666656, -0.22222222222220619, -8.8490676566798003e-13, 1.7467698467020042e-11, -1.4928496259332128e-10, 6.3617625656578573e-10, -1.3319311135565432e-09, 1.0885154464638803e-09, 0, 0, 0, 0, 0, 0, 0, 0,
0.375, -6.6214605923043568e-11, 1.6755173762288589, -7.6280937403257808e-05, -4.8980890843701941, -0.018021898856322511, 4.4035667209525009, -0.32573684124042285, -1.3468808717814833, -0.3999999999217419, -1.740520842993595e-06, 3.5092973809946266, -0.0023634636666167784, -5.1042152364769411, -0.16877907247383406, 3.6030590042734252, -1.1503449378932502, 1.0833333333333328, -0.22222222222226098, 2.0422303283935473e-12, -3.5690061332433185e-11, 2.9171682130996722e-10, -1.2248954243096851e-09, 2.5613147938041049e-09, -2.113898384560512e-09, 0, 0, 0, 0, 0, 0, 0, 0,
0.375, 0.39999999964042227, 8.7202022247939489e-06, -3.9483724431830063, 0.012181797223609256, 8.9982097567653732, 0.9203809977899835, -13.500354741726506, 7.0650696811109457, -5.9594771515108376e-10, 1.6755279162204322, -0.00069895533553120906, -6.7218330037328418, -0.16636680986314234, 11.318746525657311, -3.0517921038215845, -4.3105592839601998, 1.0000000000000693, -0.41887902182365311, 7.9169646516722642e-08, 0.30623310318269858, 1.8622340291607534e-05, -0.067272941252912777, 0.00033363440186079532, 0.0065585900629217871, 0, 0, 0, 0, 0, 0, 0, 0,
0.375, 6.5755289830448919e-10, -1.4301565382520265, 1.2415304346048617, 5.4625878674280326, -4.3244669056190377, -9.2393174837250278, 10.460454827029547, -1.3420675812492568, 0.34142135636952814, -0.29619368442734684, -3.305378421380579, 2.8137381445353573, 7.2214443804565249, -5.7235725566857738, -8.0313065505486225, 7.7314165757368576, 0.85857864376287318, -0.29619219970097815, 0.31017197009386088, 0.21653565352961049, -0.11332411524838573, -0.047836739573494456, 0.017745695199960412, 0.0029267134631612139, 0, 0, 0, 0, 0, 0, 0, 0,
0.375, -0.20000000052364189, 0.41888933602188355, 1.7539879548019037, -3.9677370902254174, -2.7094448561302902, 8.9653006868927392, -1.0870605450786082, -4.2057327282010704, 3.5336629446146352e-10, -0.83776653399367917, 1.7551125655510151, 2.438049921991746, -6.2768080658263701, -3.0373963982070804, 11.836931093408271, -5.8140371853797221, 0.80000000000018867, -4.0624848495367211e-09, 0.43864932760114006, -5.4451665710210682e-06, -0.16028312348100596, -0.00037842305650911056, 0.024762565370922928, -0.0024195898262418182, 0, 0, 0, 0, 0, 0, 0, 0,
0.375, 1.384237040122814e-10, 0.24537193372569152, -1.2405959012587209, 0.58004752405805116, 4.5470016974445295, -3.654015471603886, -6.3748997747169458, 6.4857303851046977, -0.058578644348091999, 0.29620478592150934, 0.20298453823251264, -2.7981817028740581, 1.8947206882935523, 6.9058430196409297, -8.5133307671369884, 1.4466840801582335, 0.85857864376277504, 0.2961921939556359, 0.31017185812977638, -0.21654335421962628, -0.11335045135080082, 0.047301566827341213, 0.017273863976942718, -0.0063485328707204424, 0, 0, 0, 0, 0, 0, 0, 0,
};

// The array of data is copy/pasted from the trajectory generator. Unfortunately it does not use the same
// order as in the firmware. Shuffle data around.
static void reorganizeData(float sequence[], int size) {
  int count = size / sizeof(float);
  const int perRow = 1 + 8 * 4;

  for (int i = 0; i < count / perRow; i++) {
    float* row = &sequence[i * perRow];
    float duration = row[0];

    for (int j = 0; j < 8 * 4; j++) {
      row[j] = row[j + 1];
    }

    row[8 * 4] = duration;
  }
}

void appInit() {
  if (isInit) {
    return;
  }

  timer = xTimerCreate("AppTimer", M2T(100), pdTRUE, NULL, appTimer);
  xTimerStart(timer, 100);

  pinMode(DECK_GPIO_IO3, INPUT_PULLUP);
  reorganizeData(sequence, sizeof(sequence));

  setControllerType(ControllerTypeMellinger);

  commanderEnableHighLevel(true);
  crtpCommanderHighLevelDefineTrajectory(1, 0, sequence, sizeof(sequence));

  resetLockData();

  isInit = true;
}

static bool isButtonPressed() {
  return !digitalRead(DECK_GPIO_IO3);
}

enum State {
  STATE_IDLE = 0,
  STATE_WAIT_FOR_POSITION_LOCK,
  STATE_WAIT_FOR_TAKE_OFF,
  STATE_TAKING_OFF,
  STATE_GOING_TO_INITIAL_POSITION,
  STATE_RUNNING_TRAJECTORY,

  // Low battery states
  STATE_GOING_TO_PAD,
  STATE_LANDING,
  STATE_EXHAUSTED,
};

static enum State state = STATE_IDLE;

#define TAKE_OFF_HEIGHT 0.5
#define SEQUENCE_SPEED 1.0

static void appTimer(xTimerHandle timer) {
  if (isButtonPressed()) {
    if (! hasButtonBeenPressed) {
      hasButtonBeenPressed = true;
      ledseqRun(LED_LOCK, seq_armed);
    }
  }

  if (isBatLow() && (state > STATE_TAKING_OFF) && (state < STATE_GOING_TO_PAD)) {
    DEBUG_PRINT("Battery low, going to pad...\n");
    crtpCommanderHighLevelGoTo(0.7, -0.7, 0.4, 0.0, 2.0, false, 0);
    state = STATE_GOING_TO_PAD;
  }

  switch(state) {
    case STATE_IDLE:
      DEBUG_PRINT("Let's go! Waiting for position lock...\n");
      state = STATE_WAIT_FOR_POSITION_LOCK;
      break;
    case STATE_WAIT_FOR_POSITION_LOCK:
      if (hasLock()) {
        DEBUG_PRINT("Position lock acquired, ready for take off..\n");
        ledseqRun(LED_LOCK, seq_lps_lock);
        state = STATE_WAIT_FOR_TAKE_OFF;
      }
      break;
    case STATE_WAIT_FOR_TAKE_OFF:
      if (hasButtonBeenPressed) {
        DEBUG_PRINT("Taking off!\n");
        crtpCommanderHighLevelTakeOff(TAKE_OFF_HEIGHT, 1.0, 0);
        state = STATE_TAKING_OFF;
      }
      break;
    case STATE_TAKING_OFF:
      if (crtpCommanderHighLevelIsTrajectoryFinished()) {
        DEBUG_PRINT("Hovering, going to initial position...\n");
        ledseqStop(LED_LOCK, seq_lps_lock);
        ledseqStop(LED_LOCK, seq_armed);
        crtpCommanderHighLevelGoTo(sequence[0], sequence[8], sequence[16], sequence[24], 2.0, false, 0);
        state = STATE_GOING_TO_INITIAL_POSITION;
      }
      break;
    case STATE_GOING_TO_INITIAL_POSITION:
      if (crtpCommanderHighLevelIsTrajectoryFinished()) {
        DEBUG_PRINT("At initial position, starting trajectory...\n");
        crtpCommanderHighLevelStartTrajectory(1, SEQUENCE_SPEED, false, false, 0);
        state = STATE_RUNNING_TRAJECTORY;
      }
      break;
    case STATE_RUNNING_TRAJECTORY:
      if (crtpCommanderHighLevelIsTrajectoryFinished()) {
        DEBUG_PRINT("Trajectory finished, restarting...\n");
        crtpCommanderHighLevelStartTrajectory(1, SEQUENCE_SPEED, false, false, 0);
      }
      break;
    case STATE_GOING_TO_PAD:
      if (crtpCommanderHighLevelIsTrajectoryFinished()) {
        DEBUG_PRINT("At pad, landing...\n");
        crtpCommanderHighLevelLand(0.02, 1.0, 0);
        state = STATE_LANDING;
      }
      break;
    case STATE_LANDING:
      if (crtpCommanderHighLevelIsTrajectoryFinished()) {
        DEBUG_PRINT("Landed. Feed me!\n");
        crtpCommanderHighLevelStop();
        state = STATE_EXHAUSTED;
      }
      break;
    default:
      break;
  }
}


static bool hasLock() {
  bool result = false;

  // Store current state
  lockData[lockWriteIndex][0] = getVarPX();
  lockData[lockWriteIndex][1] = getVarPY();
  lockData[lockWriteIndex][2] = getVarPZ();

  lockWriteIndex++;
  if (lockWriteIndex >= LOCK_LENGTH) {
    lockWriteIndex = 0;
  }

  // Check if we have a lock
  int count = 0;

  float lXMax = FLT_MIN;
  float lYMax = FLT_MIN;
  float lZMax = FLT_MIN;

  float lXMin = FLT_MAX;
  float lYMin = FLT_MAX;
  float lZMin = FLT_MAX;

  for (int i = 0; i < LOCK_LENGTH; i++) {
    if (lockData[i][0] != FLT_MAX) {
      count++;

      lXMax = fmaxf(lXMax, lockData[i][0]);
      lYMax = fmaxf(lYMax, lockData[i][1]);
      lZMax = fmaxf(lZMax, lockData[i][2]);

      lXMin = fminf(lXMax, lockData[i][0]);
      lYMin = fminf(lYMin, lockData[i][1]);
      lZMin = fminf(lZMin, lockData[i][2]);
    }
  }

  // TODO krri Check that all anchors are received?

  result = (count >= LOCK_LENGTH) && ((lXMax - lXMin) < LOCK_THRESHOLD) && ((lYMax - lYMin) < LOCK_THRESHOLD) && ((lZMax - lZMin) < LOCK_THRESHOLD && sensorsAreCalibrated());
  return result;
}

static void resetLockData() {
    lockWriteIndex = 0;
    for (uint32_t i = 0; i < LOCK_LENGTH; i++) {
      lockData[i][0] = FLT_MAX;
      lockData[i][1] = FLT_MAX;
      lockData[i][2] = FLT_MAX;
    }
}
