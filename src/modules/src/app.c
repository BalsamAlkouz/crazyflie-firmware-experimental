#include <float.h>
#include <math.h>

#include "FreeRTOS.h"
#include "timers.h"
#include "deck_digital.h"
#include "deck_constants.h"
#include "sensors.h"
#include "estimator_kalman.h"
#include "crtp_commander_high_level.h"
#include "commander.h"
#include "pm.h"
#include "stabilizer.h"
#include "ledseq.h"

#define DEBUG_MODULE "APP"
#include "debug.h"



static xTimerHandle timer;
static bool isInit = false;

static void appTimer(xTimerHandle timer);

#define LED_LOCK         LED_GREEN_R
#define LOCK_LENGTH 50
#define LOCK_THRESHOLD 0.001f
static uint32_t lockWriteIndex;
static float lockData[LOCK_LENGTH][3];
static void resetLockData();
static bool hasLock();

static bool hasButtonBeenPressed = true;
static bool isBatLowDetected = false;

#define USE_MELLINGER

// duration, x0-x7, y0-y7, z0-z7, yaw0-yaw7
static float sequence[] = {
0.55,3.850187562676742e-11,-6.126680001583386e-07,0.034011535082562466,-0.0003930116221214229,-0.13617012073728407,-0.013475566231476182,0.13052917793131502,-0.04578980321072286,5.13033102278894e-11,-6.894694832263486e-07,2.7736466486255528e-05,0.09665022145136354,0.003058298046984803,-0.14597702960520773,0.025898651835890598,0.031816204956814045,0.7935094937573053,0.3354737430678545,0.02905716059100962,-0.01266832414065918,-0.0005486334053357801,0.00014350779363707874,4.164220571012499e-06,-8.016674886653787e-07,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,
0.55,-6.914788682055622e-11,-0.029193709157554027,-0.10559495462082236,-0.05347086572904071,0.1429864490023195,0.13154711964776383,-0.10576667456482508,-0.004894549656606144,0.010222252124903127,0.03695902744452226,-0.0088512292032624,-0.1522994840241329,-0.10473818933895811,0.101347754562758,0.10503082012800732,-0.06287119477122378,0.9846592732952832,0.35564176146138293,0.007402285627033548,-0.013429918474692307,-0.00013976440813500847,0.00015214419394013828,1.056118490270222e-06,-8.233001847834489e-07,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,
0.55,-0.04019237884462183,-0.07140003156906653,0.1344931065364669,0.2937887095214804,0.009789196771361027,-0.21053548856185011,-0.05387360520003008,0.07164061868443176,-7.889581297779964e-11,-0.11478801738672623,-0.20396423865607044,0.07270282032653184,0.2794859692648988,0.07498870791184684,-0.17675426223153057,0.027076140218982695,1.1802619153775318,0.351573381537141,-0.01475704287071262,-0.01327628604604266,0.00027862923950955836,0.0001504123825327982,-2.1241728115759334e-06,-7.887110853306586e-07,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,
0.55,7.988284484732011e-11,0.250949124563498,0.2884318844281135,-0.2732723085219975,-0.3971380460135978,0.019843843315547182,0.23402372804388663,-0.06191711498753417,-0.08786796558968513,-0.1009753021910108,0.33435181061014774,0.4152184312151822,-0.14220624001585802,-0.30664667217939623,0.019456187255464174,0.07150045317180133,1.3669874231947945,0.32354585666358887,-0.03591070328275911,-0.012217896675003542,0.0006780348146825326,0.00013843010365626902,-5.159575179539306e-06,-7.004338319395965e-07,-8.314418855166948e-17,2.855993321445286,-4.4522405463652314e-13,3.6027429443266216e-12,-1.4127312536830109e-11,2.8100825191264194e-11,-2.6527583249725554e-11,8.815269909223687e-12,
0.55,0.1499999999110494,0.1236693334929018,-0.5948073010234445,-0.5083134142475911,0.34088988320791197,0.38313148703735755,-0.10996125300699039,-0.06246025031151826,7.204165642107989e-11,0.42839787625064485,0.3532415614668606,-0.5345691196919508,-0.48792488465828615,0.14648785242312232,0.27367225249021054,-0.09725401975942494,1.5321107619678163,0.2734692163433272,-0.05461710861392965,-0.01032687781215039,0.0010312333248967134,0.00011701432034557819,-7.843713648011883e-06,-5.642433768342176e-07,1.570796326794896,2.855993321445219,1.1415585581287713e-12,-1.1944049757036972e-11,6.431141607525981e-11,-1.8343792153223745e-10,2.6289169140858755e-10,-1.4907548089075316e-10,
0.55,-5.590663147591574e-11,-0.6350414332686105,-0.39397659738539126,0.8387863079720367,0.5456595121538056,-0.29631273940020514,-0.29299785427839664,0.130678702950142,0.2223542863477553,0.13793556474518312,-0.8981099665280236,-0.5667293893693737,0.5727217708530097,0.43477761941329673,-0.21147382139585272,-0.04513608499171106,1.6643790490384378,0.20475610085832574,-0.06960144824708228,-0.007732099342972799,0.0013141552403922365,8.76235386208019e-05,-9.992424517287934e-06,-3.900765488732202e-07,-3.1415926535897913,2.855993321445259,2.5087977390525737e-13,-1.1471253057481462e-12,-3.6097331487140355e-12,3.293016202670872e-11,-7.167566690499768e-11,5.132340432324304e-11,
0.55,-0.2999999998502529,-0.14280177586409412,1.2235902317016245,0.5864854044065786,-0.821902942890023,-0.4580654708546404,0.3170759788277885,0.020708570338654426,-3.2577411606298086e-11,-0.8567973787012538,-0.40786096680320616,1.16519197471624,0.5664074090974773,-0.4591081859649081,-0.29068352530931285,0.1599133274637631,1.7547784192264724,0.12208919547550054,-0.07984256421003652,-0.004610391019459922,0.0015075193336050374,5.226219779463491e-05,-1.1461302393055517e-05,-1.8871753582501408e-07,-1.570796326794896,2.855993321445285,-4.225442457827085e-13,4.4049449702295166e-12,-2.3950348360899724e-11,6.851557251898727e-11,-9.803060051919491e-11,5.52677029888256e-11,
0.55,3.643713234144152e-12,1.0785534113363267,0.3939484728911548,-1.4915421131692534,-0.5487546404587444,0.6237799510123201,0.266886983994221,-0.18296560239343668,-0.3776457133589556,-0.1379363426036038,1.5490671543520358,0.5662351196076164,-1.0714521143729914,-0.4514080123736052,0.41957111221051374,-0.00915759855778746,1.7971483048456298,0.031102113182836875,-0.08464254136452284,-0.0011744922063590393,0.0015981486813140384,1.333871459271064e-05,-1.2148348501534667e-05,2.509082433186678e-08,-8.314418855166948e-17,2.855993321445286,-4.4522405463652314e-13,3.6027429443266216e-12,-1.4127312536830109e-11,2.8100825191264194e-11,-2.6527583249725554e-11,8.815269909223687e-12,
0.55,0.44999999981385364,0.12367083619999372,-1.8523600200796242,-0.5073585583818294,1.3043629214703734,0.41525893933383995,-0.5119743484215598,0.04242709212774574,-2.89226389768401e-11,1.285197224018999,0.35318722911504113,-1.7955965006790715,-0.4939042134616532,0.7791059265493233,0.223229924284725,-0.19826455269120852,1.7886012682105115,-0.062004526724562394,-0.08367426920381038,0.002341446315032509,0.001579866806884801,-2.6493697219296558e-05,-1.2007610144248998e-05,2.372400128789868e-07,1.570796326794896,2.855993321445219,1.1415585581287713e-12,-1.1944049757036972e-11,6.431141607525981e-11,-1.8343792153223745e-10,2.6289169140858755e-10,-1.4907548089075316e-10,
0.55,6.290210506218638e-11,-1.4626463824098959,-0.28835504688017033,2.056634333247623,0.40559409384743944,-0.914500903393737,-0.16268750359645887,0.20476758072452098,0.5121320341641584,0.10097742733972069,-2.11279992129731,-0.41386806111463986,1.504762877791794,0.35208175069725167,-0.5879885586908895,0.07683264882809585,1.7297197757431542,-0.15088566060303898,-0.07700373387480282,0.005697819139161142,0.0014539196087420929,-6.452054150178085e-05,-1.1048707767333412e-05,4.333178001006606e-07,-3.1415926535897913,2.855993321445259,2.5087977390525737e-13,-1.1471253057481462e-12,-3.6097331487140355e-12,3.293016202670872e-11,-7.167566690499768e-11,5.132340432324304e-11,
0.55,-0.5598076209469373,-0.07140263433406184,2.3126383091368354,0.29213485066461087,-1.6589950573170387,-0.26618186797986115,0.6424335009665487,-0.1100295872652435,9.597957855088104e-11,-1.5988080196133752,-0.20387013226277426,2.256866313938279,0.28984247051151446,-1.0207379381606654,-0.08938558706550837,0.20203151543026565,1.624516503848941,-0.2294841860616984,-0.06508552133795634,0.008665895010979231,0.0012288901825039016,-9.815044046765835e-05,-9.336766383471845e-06,5.997922239478524e-07,-1.570796326794896,2.855993321445285,-4.225442457827085e-13,4.4049449702295166e-12,-2.3950348360899724e-11,6.851557251898727e-11,-9.803060051919491e-11,5.52677029888256e-11,
0.55,-1.2590019835852742e-10,1.6844029450716946,0.10548999257784991,-2.3826469641845596,-0.1545376251943579,1.09057715220263,0.00831957959381703,-0.19024281538328217,-0.5897777477105767,-0.0369619304516384,2.4382565277141275,0.1504548441642516,-1.7565487919657432,-0.16341322602586436,0.6715988421120441,-0.13975559077778596,1.4801608816508356,-0.29244374348085167,-0.04873183807945275,0.011043404447394229,0.0009201139619114843,-0.00012509161325377147,-6.988506654803558e-06,7.253985575183414e-07,-8.314418855166948e-17,2.855993321445286,-4.4522405463652314e-13,3.6027429443266216e-12,-1.4127312536830109e-11,2.8100825191264194e-11,-2.6527583249725554e-11,8.815269909223687e-12,
0.55,0.5999999998441106,2.392746148312848e-06,-2.4810939030286048,0.001516700094742569,1.7907759558714795,0.05077933811777355,-0.6734970125477634,0.1639848814705509,-1.506250987376076e-10,1.7135980060672011,-8.092823644568708e-05,-2.4254045405309936,-0.00890035951518397,1.1192591185216,-0.07498600440013853,-0.17020486100199314,1.3064905062426944,-0.33547374306784866,-0.029057160591416886,0.012668324145176095,0.0005486333816531073,-0.00014350772556166668,-4.164322285105537e-06,8.017281263171531e-07,1.570796326794896,2.855993321445219,1.1415585581287713e-12,-1.1944049757036972e-11,6.431141607525981e-11,-1.8343792153223745e-10,2.6289169140858755e-10,-1.4907548089075316e-10,
0.55,1.684697291033214e-10,-1.6844036074401618,0.10564814639079924,2.382225184807529,-0.1371443875231521,-1.1048292086075555,0.1548540272068101,0.14328320564974964,0.5897777477577096,-0.036957247366396044,-2.4382311387421707,0.1534231724906406,1.7593440245030696,-0.06404398275378732,-0.6479986546427713,0.18106627297730243,1.1153407267047157,-0.3556417614614604,-0.007402285624669944,0.013429918448246194,0.00013976454989605397,-0.00015214458573987574,-1.0555792666857342e-06,8.230072136837704e-07,-3.1415926535897913,2.855993321445259,2.5087977390525737e-13,-1.1471253057481462e-12,-3.6097331487140355e-12,3.293016202670872e-11,-7.167566690499768e-11,5.132340432324304e-11,
0.55,-0.5598076210379905,0.07139825149092185,2.312589261409516,-0.2949123979936194,-1.664395031908084,0.17323171668372522,0.5968414398024987,-0.18983569693480895,1.7821782545551847e-10,-1.5988092992110026,0.20401743042640863,2.25605149874844,-0.2736439077696821,-1.0482707969090843,0.22584161491618038,0.11131251575573874,0.9197380846224673,-0.3515733815371727,0.014757042871413485,0.013276286037855516,-0.00027862919082292665,-0.00015041252851815293,2.1243851256122656e-06,7.885913544814063e-07,-1.570796326794896,2.855993321445285,-4.225442457827085e-13,4.4049449702295166e-12,-2.3950348360899724e-11,6.851557251898727e-11,-9.803060051919491e-11,5.52677029888256e-11,
0.55,-1.7920484419930034e-10,1.462648192034213,-0.2884850761977632,-2.055482010561792,0.39129598457085574,0.9534382455215172,-0.2831110804852299,-0.07647154113270976,-0.5121320342929275,0.10097352211288317,2.11273055733514,-0.41634211967852053,-1.5123995951714493,0.2693429004489931,0.5235116471329888,-0.1896955312999179,0.733012576805205,-0.32354585666366387,0.03591070328463513,0.012217896654622508,-0.0006780347052174895,-0.00013843041082152173,5.1600073346049936e-06,7.001934198076787e-07,-8.314418855166948e-17,2.855993321445286,-4.4522405463652314e-13,3.6027429443266216e-12,-1.4127312536830109e-11,2.8100825191264194e-11,-2.6527583249725554e-11,8.815269909223687e-12,
0.55,0.44999999997156337,-0.12366755341478729,-1.8522750669218213,0.5094371027127081,1.3137159519637331,-0.34582771525204625,-0.43300658146993454,0.180655328493912,-1.713634072390606e-10,1.2851994403470866,-0.3532947532373552,-1.7941851993804268,0.48208282314515644,0.8267942366336414,-0.3227596052703462,-0.041134636155708774,0.5678892380321827,-0.2734692163433015,0.05461710861256906,0.010326877829324174,-0.0010312334210825307,-0.00011701404602320634,7.843324162840977e-06,5.644617626717801e-07,1.570796326794896,2.855993321445219,1.1415585581287713e-12,-1.1944049757036972e-11,6.431141607525981e-11,-1.8343792153223745e-10,2.6289169140858755e-10,-1.4907548089075316e-10,
0.55,1.552285277508215e-10,-1.0785558833291304,0.3940297891560065,1.4899680111000886,-0.5398174506435933,-0.6769693496382162,0.34208520701934,0.0077099529941195115,0.3776457135348575,-0.13793378466699563,-1.5489724014191015,0.5678530778537859,1.0818840642180365,-0.3974738473501345,-0.33149401346895935,0.16333116338935125,0.4356209509615618,-0.204756100858405,0.0696014482487446,0.007732099328572144,-0.0013141551765168047,-8.76236893750663e-05,9.992603623318908e-06,3.899926850049059e-07,-3.1415926535897913,2.855993321445259,2.5087977390525737e-13,-1.1471253057481462e-12,-3.6097331487140355e-12,3.293016202670872e-11,-7.167566690499768e-11,5.132340432324304e-11,
0.55,-0.30000000003235977,0.14279999578597702,1.2234921362438944,-0.587609092875647,-0.8327028922566038,0.4207616989920525,0.2258918557649712,-0.13890364858850515,1.3189926344258986e-10,-0.8567999378964555,0.407914158573091,1.1635623443630034,-0.5605653476226719,-0.5141739029796313,0.3397708779238144,-0.021524671451362908,0.345221580773527,-0.12208919547552355,0.07984256421024431,0.00461039101851865,-0.0015075193297081962,-5.226221056367274e-05,1.146132530331506e-05,1.8870150914158072e-07,-1.570796326794896,2.855993321445285,-4.225442457827085e-13,4.4049449702295166e-12,-2.3950348360899724e-11,6.851557251898727e-11,-9.803060051919491e-11,5.52677029888256e-11,
0.55,-1.029656785148531e-10,0.6350439052614014,-0.39400166466153436,-0.8372122059040767,0.5429125789487638,0.3495021380409436,-0.3159743367761405,0.04457694648242842,-0.2223542865236572,0.13793456252546576,0.8980152135936907,-0.5673588080774555,-0.5831537207722597,0.4141042405096757,0.12339672238346343,-0.10903747969310579,0.3028516951543694,-0.031102113182853997,0.08464254136506678,0.0011744921991043837,-0.0015981486361943357,-1.3338853330158306e-05,1.2148554786557712e-05,-2.5209747312717627e-08,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,
0.55,0.1500000000687584,-0.12366905612177849,-0.594722347868441,0.5084822468775191,0.35024291353796916,-0.3779551670922615,-0.030993486696122376,0.07576798641159813,-7.039928298561939e-11,0.42840009257875555,-0.3532404208862144,-0.533157818385911,0.48806215190950436,0.19417616261494053,-0.2723172772132073,0.059875896856828974,0.3113987317894881,0.06200452672453079,0.08367426920487678,-0.002341446329324818,-0.001579866716977239,2.649341326787674e-05,1.2008047765330275e-05,-2.3750222557732432e-07,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,
0.55,3.6419711080421585e-11,-0.2509509341878004,0.28840823864950105,0.2721199858390575,-0.3997520324183086,-0.05878118540823653,0.21177485599121348,-0.0663789245795264,0.08786796571845405,-0.10097564726160337,-0.3342824466477831,0.41499174957660356,0.14984295740004752,-0.3147779789736173,0.045020724305445986,0.04136242930126668,0.3702802242568455,0.1508856606029918,0.07700373387575327,-0.0056978191490940225,-0.001453919554856414,6.452038928727077e-05,1.1048921530556284e-05,-4.3343615282146336e-07,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,
0.55,-0.040192378935675475,0.07140085425594436,0.13444405880828958,-0.29325853912678074,0.004389222125442104,0.2288780962570675,-0.09946566658297257,-0.008165490863377235,3.342506343117202e-12,-0.11478929698434916,0.2039233240328519,0.07188800514013687,-0.28400040903603785,0.047455849220319694,0.1384729396693574,-0.06364285941067112,0.47548349615105834,0.2294841860616628,0.06508552133912934,-0.00866589502849182,-0.0012288900659405738,9.81500632521752e-05,9.337352648129491e-06,-6.001434566157721e-07,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,
0.55,2.657819140362752e-11,0.029194371526024346,-0.10554318434787024,0.05389264510610344,0.14869556371716416,-0.11729506325396347,-0.057406932212603616,0.05185415937314559,-0.01022225217203592,0.036960150373509054,0.00882584023135473,-0.15157853263098095,0.10194295680128089,0.12610945422193115,-0.12863100760957105,0.021560512581067035,0.6198391183491636,0.2924437434807592,0.048731838082296135,-0.011043404480377293,-0.0009201137794061297,0.00012509109220050886,6.989248987851544e-06,-7.258163205251983e-07,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,
};

// The array of data is copy/pasted from the trajectory generator. Unfortunately it does not use the same
// order as in the firmware. Shuffle data around.
static void reorganizeData(float sequence[], int size) {
  int count = size / sizeof(float);
  const int perRow = 1 + 8 * 4;

  for (int i = 0; i < count / perRow; i++) {
    float* row = &sequence[i * perRow];
    float duration = row[0];

    for (int j = 0; j < 8 * 4; j++) {
      row[j] = row[j + 1];
    }

    row[8 * 4] = duration;
  }
}

void appInit() {
  if (isInit) {
    return;
  }

  timer = xTimerCreate("AppTimer", M2T(100), pdTRUE, NULL, appTimer);
  xTimerStart(timer, 100);

  pinMode(DECK_GPIO_IO3, INPUT_PULLUP);
  reorganizeData(sequence, sizeof(sequence));

  #ifdef USE_MELLINGER
  setControllerType(ControllerTypeMellinger);
  #endif

  commanderEnableHighLevel(true);
  crtpCommanderHighLevelDefineTrajectory(1, 0, sequence, sizeof(sequence));

  resetLockData();

  isInit = true;
}

static bool isButtonPressed() {
  return !digitalRead(DECK_GPIO_IO3);
}

enum State {
  STATE_IDLE = 0,
  STATE_WAIT_FOR_POSITION_LOCK,
  STATE_WAIT_FOR_TAKE_OFF,
  STATE_TAKING_OFF,
  STATE_GOING_TO_INITIAL_POSITION,
  STATE_RUNNING_TRAJECTORY,

  // Low battery states
  STATE_GOING_TO_PAD,
  STATE_LANDING,
  STATE_EXHAUSTED,
};

static enum State state = STATE_IDLE;

#define TAKE_OFF_HEIGHT 0.5
#define SEQUENCE_SPEED 1.0

static void appTimer(xTimerHandle timer) {
  if (isButtonPressed()) {
    if (! hasButtonBeenPressed) {
      hasButtonBeenPressed = true;
      ledseqRun(LED_LOCK, seq_armed);
    }
  }

  if (isBatLow()) {
    isBatLowDetected = true;
  }

  switch(state) {
    case STATE_IDLE:
      DEBUG_PRINT("Let's go! Waiting for position lock...\n");
      state = STATE_WAIT_FOR_POSITION_LOCK;
      break;
    case STATE_WAIT_FOR_POSITION_LOCK:
      if (hasLock()) {
        DEBUG_PRINT("Position lock acquired, ready for take off..\n");
        ledseqRun(LED_LOCK, seq_lps_lock);
        state = STATE_WAIT_FOR_TAKE_OFF;
      }
      break;
    case STATE_WAIT_FOR_TAKE_OFF:
      if (hasButtonBeenPressed) {
        DEBUG_PRINT("Taking off!\n");
        crtpCommanderHighLevelTakeOff(TAKE_OFF_HEIGHT, 1.0, 0);
        state = STATE_TAKING_OFF;
      }
      break;
    case STATE_TAKING_OFF:
      if (crtpCommanderHighLevelIsTrajectoryFinished()) {
        DEBUG_PRINT("Hovering, going to initial position...\n");
        ledseqStop(LED_LOCK, seq_lps_lock);
        ledseqStop(LED_LOCK, seq_armed);
        crtpCommanderHighLevelGoTo(sequence[0], sequence[8], sequence[16], sequence[24], 2.0, false, 0);
        state = STATE_GOING_TO_INITIAL_POSITION;
      }
      break;
    case STATE_GOING_TO_INITIAL_POSITION:
      if (crtpCommanderHighLevelIsTrajectoryFinished()) {
        DEBUG_PRINT("At initial position, starting trajectory...\n");
        crtpCommanderHighLevelStartTrajectory(1, SEQUENCE_SPEED, false, false, 0);
        state = STATE_RUNNING_TRAJECTORY;
      }
      break;
    case STATE_RUNNING_TRAJECTORY:
      if (crtpCommanderHighLevelIsTrajectoryFinished()) {
        if (isBatLowDetected) {
          DEBUG_PRINT("Battery low, going to pad...\n");
          crtpCommanderHighLevelGoTo(0.0, 0.0, 0.4, 0.0, 2.0, false, 0);
          state = STATE_GOING_TO_PAD;
        } else {
          DEBUG_PRINT("Trajectory finished, restarting...\n");
          crtpCommanderHighLevelStartTrajectory(1, SEQUENCE_SPEED, false, false, 0);
        }
      }
      break;
    case STATE_GOING_TO_PAD:
      if (crtpCommanderHighLevelIsTrajectoryFinished()) {
        DEBUG_PRINT("At pad, landing...\n");
        crtpCommanderHighLevelLand(0.02, 1.0, 0);
        state = STATE_LANDING;
      }
      break;
    case STATE_LANDING:
      if (crtpCommanderHighLevelIsTrajectoryFinished()) {
        DEBUG_PRINT("Landed. Feed me!\n");
        crtpCommanderHighLevelStop();
        state = STATE_EXHAUSTED;
      }
      break;
    default:
      break;
  }
}


static bool hasLock() {
  bool result = false;

  // Store current state
  lockData[lockWriteIndex][0] = getVarPX();
  lockData[lockWriteIndex][1] = getVarPY();
  lockData[lockWriteIndex][2] = getVarPZ();

  lockWriteIndex++;
  if (lockWriteIndex >= LOCK_LENGTH) {
    lockWriteIndex = 0;
  }

  // Check if we have a lock
  int count = 0;

  float lXMax = FLT_MIN;
  float lYMax = FLT_MIN;
  float lZMax = FLT_MIN;

  float lXMin = FLT_MAX;
  float lYMin = FLT_MAX;
  float lZMin = FLT_MAX;

  for (int i = 0; i < LOCK_LENGTH; i++) {
    if (lockData[i][0] != FLT_MAX) {
      count++;

      lXMax = fmaxf(lXMax, lockData[i][0]);
      lYMax = fmaxf(lYMax, lockData[i][1]);
      lZMax = fmaxf(lZMax, lockData[i][2]);

      lXMin = fminf(lXMax, lockData[i][0]);
      lYMin = fminf(lYMin, lockData[i][1]);
      lZMin = fminf(lZMin, lockData[i][2]);
    }
  }

  // TODO krri Check that all anchors are received?

  result = (count >= LOCK_LENGTH) && ((lXMax - lXMin) < LOCK_THRESHOLD) && ((lYMax - lYMin) < LOCK_THRESHOLD) && ((lZMax - lZMin) < LOCK_THRESHOLD && sensorsAreCalibrated());
  return result;
}

static void resetLockData() {
    lockWriteIndex = 0;
    for (uint32_t i = 0; i < LOCK_LENGTH; i++) {
      lockData[i][0] = FLT_MAX;
      lockData[i][1] = FLT_MAX;
      lockData[i][2] = FLT_MAX;
    }
}
