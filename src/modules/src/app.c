#include <float.h>
#include <math.h>

#include "FreeRTOS.h"
#include "timers.h"
#include "deck_digital.h"
#include "deck_constants.h"
#include "sensors.h"
#include "estimator_kalman.h"
#include "crtp_commander_high_level.h"
#include "commander.h"
#include "pm.h"
#include "stabilizer.h"
#include "ledseq.h"

#define DEBUG_MODULE "APP"
#include "debug.h"



static xTimerHandle timer;
static bool isInit = false;

static void appTimer(xTimerHandle timer);

#define LED_LOCK         LED_GREEN_R
#define LOCK_LENGTH 50
#define LOCK_THRESHOLD 0.001f
static uint32_t lockWriteIndex;
static float lockData[LOCK_LENGTH][3];
static void resetLockData();
static bool hasLock();

static bool hasButtonBeenPressed = false;

// #define USE_MELLINGER

// duration, x0-x7, y0-y7, z0-z7, yaw0-yaw7
static float sequence[] = {
#ifdef USE_MELLINGER
0.375, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.999999999999999, 0.53333333333335853, -5.1943464497897703e-13, 3.0526206318380912e-12, 7.4776942112130583e-12, -1.3664744849582766e-10, 4.7038777693818093e-10, -5.2171039881506561e-10, 0, 0, 0, 0, 0, 0, 0, 0,
0.375, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.1999999999999993, 0.53333333333337207, -8.0859090567742795e-13, 4.8667065277363849e-12, 8.2460585514821688e-12, -1.7925595692324601e-10, 6.0803975870810505e-10, -6.6115692828558184e-10, 0, 0, 0, 0, 0, 0, 0, 0,
0.375, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.3999999999999999, 0.53333333333338639, -2.1073320196152126e-12, 3.0484975673400625e-11, -2.1303054456623891e-10, 7.7593299580240979e-10, -1.416959203731171e-09, 1.0208734732132567e-09, 0, 0, 0, 0, 0, 0, 0, 0,
0.375, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.5999999999999985, 0.53333333333343291, -2.8257541086944273e-12, 3.8545544517739142e-11, -2.8154030859976456e-10, 1.1252819308470704e-09, -2.3130801912726007e-09, 1.9029941807842089e-09, 0, 0, 0, 0, 0, 0, 0, 0,
0.375, 2.8131958339343128e-10, -6.9796813927476918e-06, 0.43907506218881315, -0.0098183335636848005, -3.8939945202367308, -0.75160192552878746, 9.8972957378980251, -5.914724743590166, 5.2973316304142504e-10, -1.0539991553371599e-05, 0.00062267439724221312, 1.8237439193775469, 0.14834491088627122, -6.9151798042012524, 2.7260552615336051, 2.9636784130368379, 1.8000000000000935, -2.0314455665862202e-09, 0.2193246638086577, -2.7227056711356512e-06, -0.080141560822023505, -0.0001892151869939386, 0.012381290075693399, -0.0012098008588503578, 0, 0, 0, 0, 0, 0, 0, 0,
0.375, -5.9133831181429191e-10, -0.24536083797685185, -1.2414541536667256, -0.56449878306912982, 4.3424888045621035, 4.8357507624229843, -10.134717985082004, 2.6889484524653984, 0.058578643552213615, 0.2961954249481738, -0.20391895961339535, -2.8113746808782847, -2.1172291439105648, 5.892351628894712, 4.4282475467920861, -6.5810716382476544, 1.8292893218813862, 0.14809609697792908, 0.15508592906117441, -0.10827167705531156, -0.056675226077969584, 0.023650784987607518, 0.0086369288742763929, -0.0031742639821246039, 0, 0, 0, 0, 0, 0, 0, 0,
0.375, -0.19999999939809987, -0.41889107654270574, 1.7553094261918483, 3.9653736265718704, -2.3947703804434601, -9.1340797589844911, 4.6901195485838763, 3.0553877909260279, -2.8715168678866108e-10, -0.83775084223518381, -1.755036284613454, 2.4600391623758093, 6.294829964704217, -1.3661703228346105, -11.511194251986275, 7.1609180570171729, 1.8999999999999639, 0.20943951091189023, -3.95875521954321e-08, -0.15311655155156248, -9.3114473484538713e-06, 0.03363647163014729, -0.00016681902185535747, -0.0032792937192066131, 0, 0, 0, 0, 0, 0, 0, 0,
0.375, -2.0463831008168809e-10, 1.4301454425031788, 1.2405196203209667, -5.4781366084235046, -4.5650235963344219, 8.0575821926842046, 6.0491629332302317, -7.832611256698951, -0.34142135557364955, -0.29620652644235107, 3.3063128427620554, 2.7958182392076538, -6.9989359247690093, -7.0746220921270169, 12.116389771440227, -2.5970290180750499, 1.9707106781185624, 0.14809609985042468, -0.15508598504497043, -0.10826782678715227, 0.05666205775095421, 0.023918369398789888, -0.0088728469860457817, -0.0014633571265056662, 0, 0, 0, 0, 0, 0, 0, 0,
0.375, 0.39999999992174173, 1.7405208463408809e-06, -3.5092973809946209, 0.0023634636654587104, 5.1042152364927578, 0.16877907238447179, -3.6030590040437804, 1.150344937671506, -6.6214580190261988e-11, 1.6755173762288609, -7.628093753131103e-05, -4.8980890843676548, -0.018021898879107576, 4.403566721054105, -0.32573684146155513, -1.346880871594037, 1.9999999999999991, -0.22222222222221885, -8.5192613229773559e-13, 1.7654891761317278e-11, -1.4423756512080781e-10, 5.6543221347073291e-10, -1.0644647508925903e-09, 7.6938408548657947e-10, 0, 0, 0, 0, 0, 0, 0, 0,
0.375, 6.6214601264057594e-11, -1.6755173762288662, 7.6280937667406768e-05, 4.898089084366128, 0.018021898887754659, -4.4035667210796836, 0.3257368414983392, 1.3468808715752187, 0.39999999992174173, 1.7405208491090818e-06, -3.5092973809948118, 0.002363463669372819, 5.1042152364557491, 0.16877907256123678, -3.6030590044571396, 1.1503449380473527, 1.9166666666666656, -0.22222222222225788, 1.4852821839673571e-12, -2.1427840388108986e-11, 1.5403906106224802e-10, -5.9343073316806952e-10, 1.1694490853142454e-09, -9.2756223831880679e-10, 0, 0, 0, 0, 0, 0, 0, 0,
0.375, -0.39999999992174162, -1.7405208676746328e-06, 3.5092973809956334, -0.0023634636821481649, -5.1042152363602655, -0.16877907293329453, 3.6030590051844271, -1.1503449386101685, 6.6214602421810947e-11, -1.675517376228868, 7.6280937727953523e-05, 4.8980890843654716, 0.018021898890737333, -4.4035667210848484, 0.32573684149712073, 1.3468808715843241, 1.8333333333333326, -0.22222222222208987, -4.7669543626644346e-12, 6.7707239133701953e-11, -4.8405263359945299e-10, 1.8426087090991579e-09, -3.5619590804215482e-09, 2.7514673426869022e-09, 0, 0, 0, 0, 0, 0, 0, 0,
0.375, -6.6214605923043568e-11, 1.6755173762288589, -7.6280937403257808e-05, -4.8980890843701941, -0.018021898856322511, 4.4035667209525009, -0.32573684124042285, -1.3468808717814833, -0.3999999999217419, -1.740520842993595e-06, 3.5092973809946266, -0.0023634636666167784, -5.1042152364769411, -0.16877907247383406, 3.6030590042734252, -1.1503449378932502, 1.7499999999999998, -0.22222222222226687, 1.719408684554518e-12, -2.618734251250676e-11, 1.9794107702165415e-10, -8.0285469170343824e-10, 1.6667086366840669e-09, -1.381283781969143e-09, 0, 0, 0, 0, 0, 0, 0, 0,
0.375, 0.39999999992174173, 1.7405208463408809e-06, -3.5092973809946209, 0.0023634636654587104, 5.1042152364927578, 0.16877907238447179, -3.6030590040437804, 1.150344937671506, -6.6214580190261988e-11, 1.6755173762288609, -7.628093753131103e-05, -4.8980890843676548, -0.018021898879107576, 4.403566721054105, -0.32573684146155513, -1.346880871594037, 1.6666666666666647, -0.22222222222220123, -6.30653963419208e-13, 9.5142500799875386e-12, -7.1486113044883546e-11, 2.8346660466220242e-10, -5.7023486036555173e-10, 4.5580283513497089e-10, 0, 0, 0, 0, 0, 0, 0, 0,
0.375, 6.6214601264057594e-11, -1.6755173762288662, 7.6280937667406768e-05, 4.898089084366128, 0.018021898887754659, -4.4035667210796836, 0.3257368414983392, 1.3468808715752187, 0.39999999992174173, 1.7405208491090818e-06, -3.5092973809948118, 0.002363463669372819, 5.1042152364557491, 0.16877907256123678, -3.6030590044571396, 1.1503449380473527, 1.5833333333333321, -0.22222222222217194, -1.3829483280356106e-12, 1.6230311420173339e-11, -9.0308983594275397e-11, 2.4613484022616236e-10, -2.995412502821124e-10, 1.0857403911510341e-10, 0, 0, 0, 0, 0, 0, 0, 0,
0.375, -0.39999999992174162, -1.7405208676746328e-06, 3.5092973809956334, -0.0023634636821481649, -5.1042152363602655, -0.16877907293329453, 3.6030590051844271, -1.1503449386101685, 6.6214602421810947e-11, -1.675517376228868, 7.6280937727953523e-05, 4.8980890843654716, 0.018021898890737333, -4.4035667210848484, 0.32573684149712073, 1.3468808715843241, 1.4999999999999991, -0.2222222222221488, -2.149923000335998e-12, 2.7210646753397589e-11, -1.7820686122472847e-10, 6.3535220980180257e-10, -1.1723470217725595e-09, 8.7483618737473112e-10, 0, 0, 0, 0, 0, 0, 0, 0,
0.375, -6.6214605923043568e-11, 1.6755173762288589, -7.6280937403257808e-05, -4.8980890843701941, -0.018021898856322511, 4.4035667209525009, -0.32573684124042285, -1.3468808717814833, -0.3999999999217419, -1.740520842993595e-06, 3.5092973809946266, -0.0023634636666167784, -5.1042152364769411, -0.16877907247383406, 3.6030590042734252, -1.1503449378932502, 1.4166666666666652, -0.22222222222220986, -6.5192696571415466e-13, 1.1619217364256816e-11, -9.3192784068593404e-11, 3.779585595513954e-10, -7.5669072658117613e-10, 5.9282119120674676e-10, 0, 0, 0, 0, 0, 0, 0, 0,
0.375, 0.39999999992174173, 1.7405208463408809e-06, -3.5092973809946209, 0.0023634636654587104, 5.1042152364927578, 0.16877907238447179, -3.6030590040437804, 1.150344937671506, -6.6214580190261988e-11, 1.6755173762288609, -7.628093753131103e-05, -4.8980890843676548, -0.018021898879107576, 4.403566721054105, -0.32573684146155513, -1.346880871594037, 1.3333333333333333, -0.22222222222215371, -2.2373724608092634e-12, 2.829365149884517e-11, -1.8111941861732161e-10, 6.2462738696251741e-10, -1.1070775892682556e-09, 7.8950323650471365e-10, 0, 0, 0, 0, 0, 0, 0, 0,
0.375, 6.6214601264057594e-11, -1.6755173762288662, 7.6280937667406768e-05, 4.898089084366128, 0.018021898887754659, -4.4035667210796836, 0.3257368414983392, 1.3468808715752187, 0.39999999992174173, 1.7405208491090818e-06, -3.5092973809948118, 0.002363463669372819, 5.1042152364557491, 0.16877907256123678, -3.6030590044571396, 1.1503449380473527, 1.2499999999999993, -0.22222222222212068, -3.6452723056681053e-12, 5.1757803393090595e-11, -3.7079071825338794e-10, 1.4247178465374281e-09, -2.8025021417665267e-09, 2.2138003758229712e-09, 0, 0, 0, 0, 0, 0, 0, 0,
0.375, -0.39999999992174162, -1.7405208676746328e-06, 3.5092973809956334, -0.0023634636821481649, -5.1042152363602655, -0.16877907293329453, 3.6030590051844271, -1.1503449386101685, 6.6214602421810947e-11, -1.675517376228868, 7.6280937727953523e-05, 4.8980890843654716, 0.018021898890737333, -4.4035667210848484, 0.32573684149712073, 1.3468808715843241, 1.1666666666666656, -0.22222222222220619, -8.8490676566798003e-13, 1.7467698467020042e-11, -1.4928496259332128e-10, 6.3617625656578573e-10, -1.3319311135565432e-09, 1.0885154464638803e-09, 0, 0, 0, 0, 0, 0, 0, 0,
0.375, -6.6214605923043568e-11, 1.6755173762288589, -7.6280937403257808e-05, -4.8980890843701941, -0.018021898856322511, 4.4035667209525009, -0.32573684124042285, -1.3468808717814833, -0.3999999999217419, -1.740520842993595e-06, 3.5092973809946266, -0.0023634636666167784, -5.1042152364769411, -0.16877907247383406, 3.6030590042734252, -1.1503449378932502, 1.0833333333333328, -0.22222222222226098, 2.0422303283935473e-12, -3.5690061332433185e-11, 2.9171682130996722e-10, -1.2248954243096851e-09, 2.5613147938041049e-09, -2.113898384560512e-09, 0, 0, 0, 0, 0, 0, 0, 0,
0.375, 0.39999999964042227, 8.7202022247939489e-06, -3.9483724431830063, 0.012181797223609256, 8.9982097567653732, 0.9203809977899835, -13.500354741726506, 7.0650696811109457, -5.9594771515108376e-10, 1.6755279162204322, -0.00069895533553120906, -6.7218330037328418, -0.16636680986314234, 11.318746525657311, -3.0517921038215845, -4.3105592839601998, 1.0000000000000693, -0.41887902182365311, 7.9169646516722642e-08, 0.30623310318269858, 1.8622340291607534e-05, -0.067272941252912777, 0.00033363440186079532, 0.0065585900629217871, 0, 0, 0, 0, 0, 0, 0, 0,
0.375, 6.5755289830448919e-10, -1.4301565382520265, 1.2415304346048617, 5.4625878674280326, -4.3244669056190377, -9.2393174837250278, 10.460454827029547, -1.3420675812492568, 0.34142135636952814, -0.29619368442734684, -3.305378421380579, 2.8137381445353573, 7.2214443804565249, -5.7235725566857738, -8.0313065505486225, 7.7314165757368576, 0.85857864376287318, -0.29619219970097815, 0.31017197009386088, 0.21653565352961049, -0.11332411524838573, -0.047836739573494456, 0.017745695199960412, 0.0029267134631612139, 0, 0, 0, 0, 0, 0, 0, 0,
0.375, -0.20000000052364189, 0.41888933602188355, 1.7539879548019037, -3.9677370902254174, -2.7094448561302902, 8.9653006868927392, -1.0870605450786082, -4.2057327282010704, 3.5336629446146352e-10, -0.83776653399367917, 1.7551125655510151, 2.438049921991746, -6.2768080658263701, -3.0373963982070804, 11.836931093408271, -5.8140371853797221, 0.80000000000018867, -4.0624848495367211e-09, 0.43864932760114006, -5.4451665710210682e-06, -0.16028312348100596, -0.00037842305650911056, 0.024762565370922928, -0.0024195898262418182, 0, 0, 0, 0, 0, 0, 0, 0,
0.375, 1.384237040122814e-10, 0.24537193372569152, -1.2405959012587209, 0.58004752405805116, 4.5470016974445295, -3.654015471603886, -6.3748997747169458, 6.4857303851046977, -0.058578644348091999, 0.29620478592150934, 0.20298453823251264, -2.7981817028740581, 1.8947206882935523, 6.9058430196409297, -8.5133307671369884, 1.4466840801582335, 0.85857864376277504, 0.2961921939556359, 0.31017185812977638, -0.21654335421962628, -0.11335045135080082, 0.047301566827341213, 0.017273863976942718, -0.0063485328707204424, 0, 0, 0, 0, 0, 0, 0, 0,
#else
0.625, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.99999999999999878, 0.3199999999999627, 9.4134622099134832e-13, -8.9166450562238123e-12, 4.1653587027996441e-11, -1.0254335731712184e-10, 1.27219743519237e-10, -6.2477186825274922e-11, 0, 0, 0, 0, 0, 0, 0, 0,
0.625, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.1999999999999991, 0.31999999999994727, 1.4447163269351778e-12, -1.4298931351470706e-11, 6.7769303238141906e-11, -1.6632449849412986e-10, 2.0366651483566844e-10, -9.8299123753848004e-11, 0, 0, 0, 0, 0, 0, 0, 0,
0.625, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.399999999999999, 0.31999999999996426, 7.0401598156337732e-13, -5.6912827921229133e-12, 2.3583487983773984e-11, -5.2825094882746094e-11, 6.0707549406199037e-11, -2.799529524669997e-11, 0, 0, 0, 0, 0, 0, 0, 0,
0.625, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.5999999999999994, 0.31999999999991474, 1.9664991881568821e-12, -1.7769154498125124e-11, 7.9066780439072439e-11, -1.8526358130332683e-10, 2.1869590459805556e-10, -1.0220273412123385e-10, 0, 0, 0, 0, 0, 0, 0, 0,
0.625, 2.8131958735274152e-10, -4.187808835751291e-06, 0.1580670223879731, -0.0021207600497535101, -0.50466168982270854, -0.05844456572900892, 0.46176822994718347, -0.16557443858205026, 5.2973315780303322e-10, -6.3239949312870979e-06, 0.00022416278298669295, 0.39392868658576113, 0.019225500449803385, -0.53772438157191904, 0.12718683427846625, 0.082964028025088121, 1.8000000000000929, -1.218896388741884e-09, 0.078956878971752992, -5.8811041278547091e-07, -0.010386346255185445, -1.4713436994628491e-05, 0.00057766154364326066, -3.3866714337923459e-05, 0, 0, 0, 0, 0, 0, 0, 0,
0.625, -5.9133827705779542e-10, -0.14721650278611578, -0.44692349531991626, -0.12193173714388734, 0.56278654907565351, 0.37602797927515536, -0.47284540229836991, 0.075273347392120021, 0.058578643552213601, 0.17771725496890417, -0.073410825460828777, -0.60725693106961254, -0.27439289705136499, 0.45818926266440613, 0.20660431754101827, -0.18422788701132514, 1.8292893218813868, 0.088857658186644456, 0.055830934464435621, -0.023386682264889817, -0.0073451092097184872, 0.0018390848371600164, 0.00040296478530768077, -8.8859180772382534e-05, 0, 0, 0, 0, 0, 0, 0, 0,
0.625, -0.19999999939809981, -0.25133464592562837, 0.63191139342918778, 0.85652070333845454, -0.31036224130083367, -0.71026604206937149, 0.21882221767146778, 0.085531303657937749, -2.8715169618261918e-10, -0.50265050534111744, -0.63181306246066815, 0.53136845907152808, 0.81580996343340562, -0.10623340432299427, -0.53706627899604209, 0.20045987570844565, 1.8999999999999635, 0.12566370654703168, -1.424933711751288e-08, -0.033073175153680245, -1.2066847488299851e-06, 0.0026155718560863647, -7.7829050012770292e-06, -9.1799328907480997e-05, 0, 0, 0, 0, 0, 0, 0, 0,
0.625, -2.0463833005028277e-10, 0.85808726550190206, 0.44658706331562115, -1.1832775074198283, -0.59162705808455607, 0.62655759130477218, 0.282229745807907, -0.21926298647183909, -0.34142135557364955, -0.17772391586539152, 1.1902726233938785, 0.60389673967314716, -0.90706209586967723, -0.55012261383661865, 0.5653022811190791, -0.072700191492869909, 1.9707106781185613, 0.088857659910157774, -0.055830954613724622, -0.023385850609554063, 0.0073434027930732344, 0.0018598921437374674, -0.00041397123514295677, -4.0964783345369395e-05, 0, 0, 0, 0, 0, 0, 0, 0,
0.625, 0.39999999992174168, 1.044312483119511e-06, -1.2633470571575667, 0.0005105081475333098, 0.66150629466746602, 0.013124260627520085, -0.16810432084507373, 0.032202296025313673, -6.6214614992313235e-11, 1.0053104257373287, -2.7461137817621048e-05, -1.0579872422204624, -0.0023356381087562255, 0.34242134826423098, -0.015197578119398168, -0.037704044344962308, 1.9999999999999989, -0.13333333333339706, 1.385906851003846e-12, -1.2546849019769331e-11, 5.7310500769369397e-11, -1.3879573058910969e-10, 1.6944400128348993e-10, -8.1820450138291347e-11, 0, 0, 0, 0, 0, 0, 0, 0,
0.625, 6.6214631113624115e-11, -1.0053104257373293, 2.7461137818807006e-05, 1.0579872422205223, 0.0023356381082782741, -0.34242134826272946, 0.01519757811725638, 0.037704044346114206, 0.39999999992174162, 1.0443124730290881e-06, -1.2633470571572853, 0.00051050814489219211, 0.66150629467931221, 0.013124260599731027, -0.1681043208121257, 0.032202296009716226, 1.9166666666666654, -0.13333333333346015, 2.7804620083459612e-12, -2.3726347070115544e-11, 1.0117197984667841e-10, -2.2961859410754277e-10, 2.6456150909476168e-10, -1.2134207748968533e-10, 0, 0, 0, 0, 0, 0, 0, 0,
0.625, -0.39999999992174168, -1.0443124728245817e-06, 1.263347057157324, -0.00051050814543963387, -0.66150629467624533, -0.013124260608191688, 0.16810432082354812, -0.032202296015744002, 6.621474510529159e-11, -1.0053104257373344, 2.7461137885919933e-05, 1.0579872422201722, 0.0023356381089745647, -0.34242134826274756, 0.015197578115704583, 0.03770404434749431, 1.8333333333333317, -0.1333333333333665, 8.1096954180839058e-13, -7.5707380711143997e-12, 3.4692911049207591e-11, -8.4037548087565929e-11, 1.0292258857112931e-10, -4.9834150262249137e-11, 0, 0, 0, 0, 0, 0, 0, 0,
0.625, -6.621478607310093e-11, 1.0053104257373267, -2.7461137687980931e-05, -1.0579872422220777, -0.0023356381000144777, 0.34242134824074066, -0.015197578088572708, -0.03770404436072726, -0.39999999992174173, -1.0443124698379609e-06, 1.2633470571572296, -0.00051050814445991019, -0.66150629468109079, -0.01312426059568563, 0.16810432080732068, -0.032202296007395423, 1.7499999999999987, -0.13333333333337669, 8.2664508908850223e-13, -6.8312980313377701e-12, 2.8674996456407096e-11, -6.4838798367503948e-11, 7.4984086890568383e-11, -3.4413918263719979e-11, 0, 0, 0, 0, 0, 0, 0, 0,
0.625, 0.39999999992174168, 1.044312483119511e-06, -1.2633470571575667, 0.0005105081475333098, 0.66150629466746602, 0.013124260627520085, -0.16810432084507373, 0.032202296025313673, -6.6214614992313235e-11, 1.0053104257373287, -2.7461137817621048e-05, -1.0579872422204624, -0.0023356381087562255, 0.34242134826423098, -0.015197578119398168, -0.037704044344962308, 1.6666666666666661, -0.13333333333341413, 1.7635309978527789e-12, -1.5536174997752787e-11, 6.8249905213617093e-11, -1.5894751272688955e-10, 1.8750631022303427e-10, -8.8015732263645004e-11, 0, 0, 0, 0, 0, 0, 0, 0,
0.625, 6.6214631113624115e-11, -1.0053104257373293, 2.7461137818807006e-05, 1.0579872422205223, 0.0023356381082782741, -0.34242134826272946, 0.01519757811725638, 0.037704044346114206, 0.39999999992174162, 1.0443124730290881e-06, -1.2633470571572853, 0.00051050814489219211, 0.66150629467931221, 0.013124260599731027, -0.1681043208121257, 0.032202296009716226, 1.5833333333333321, -0.13333333333333522, 2.6884994910225734e-13, -3.6071225124547215e-12, 1.9714691918887751e-11, -5.1952212680510184e-11, 6.5578042715007776e-11, -3.1685275195970172e-11, 0, 0, 0, 0, 0, 0, 0, 0,
0.625, -0.39999999992174168, -1.0443124728245817e-06, 1.263347057157324, -0.00051050814543963387, -0.66150629467624533, -0.013124260608191688, 0.16810432082354812, -0.032202296015744002, 6.621474510529159e-11, -1.0053104257373344, 2.7461137885919933e-05, 1.0579872422201722, 0.0023356381089745647, -0.34242134826274756, 0.015197578115704583, 0.03770404434749431, 1.4999999999999982, -0.13333333333337763, 1.1756132841689408e-12, -1.1142365100146839e-11, 5.092873184918183e-11, -1.2150434381027407e-10, 1.4539882138353511e-10, -6.8643337529976443e-11, 0, 0, 0, 0, 0, 0, 0, 0,
0.625, -6.621478607310093e-11, 1.0053104257373267, -2.7461137687980931e-05, -1.0579872422220777, -0.0023356381000144777, 0.34242134824074066, -0.015197578088572708, -0.03770404436072726, -0.39999999992174173, -1.0443124698379609e-06, 1.2633470571572296, -0.00051050814445991019, -0.66150629468109079, -0.01312426059568563, 0.16810432080732068, -0.032202296007395423, 1.416666666666665, -0.13333333333338623, 1.4572859075756214e-12, -1.4031247405887458e-11, 6.4582122910724984e-11, -1.5439874188390604e-10, 1.8480526062149304e-10, -8.7306867694443096e-11, 0, 0, 0, 0, 0, 0, 0, 0,
0.625, 0.39999999992174168, 1.044312483119511e-06, -1.2633470571575667, 0.0005105081475333098, 0.66150629466746602, 0.013124260627520085, -0.16810432084507373, 0.032202296025313673, -6.6214614992313235e-11, 1.0053104257373287, -2.7461137817621048e-05, -1.0579872422204624, -0.0023356381087562255, 0.34242134826423098, -0.015197578119398168, -0.037704044344962308, 1.3333333333333328, -0.13333333333337027, 8.9634105562136717e-13, -8.6850026903538351e-12, 4.069582523893594e-11, -9.9192928129506207e-11, 1.2091114871609231e-10, -5.8078342306802821e-11, 0, 0, 0, 0, 0, 0, 0, 0,
0.625, 6.6214631113624115e-11, -1.0053104257373293, 2.7461137818807006e-05, 1.0579872422205223, 0.0023356381082782741, -0.34242134826272946, 0.01519757811725638, 0.037704044346114206, 0.39999999992174162, 1.0443124730290881e-06, -1.2633470571572853, 0.00051050814489219211, 0.66150629467931221, 0.013124260599731027, -0.1681043208121257, 0.032202296009716226, 1.2499999999999996, -0.13333333333334127, 6.6595383877319027e-14, -5.1542357260034287e-13, 1.9708132434524923e-12, -2.6686155435543662e-12, -7.7128947666308755e-13, 3.0199572742711376e-12, 0, 0, 0, 0, 0, 0, 0, 0,
0.625, -0.39999999992174168, -1.0443124728245817e-06, 1.263347057157324, -0.00051050814543963387, -0.66150629467624533, -0.013124260608191688, 0.16810432082354812, -0.032202296015744002, 6.621474510529159e-11, -1.0053104257373344, 2.7461137885919933e-05, 1.0579872422201722, 0.0023356381089745647, -0.34242134826274756, 0.015197578115704583, 0.03770404434749431, 1.1666666666666661, -0.13333333333340547, 1.5122136468416723e-12, -1.2668483933605699e-11, 5.3457050727346264e-11, -1.2002953093831726e-10, 1.3653052883513006e-10, -6.1739190835420878e-11, 0, 0, 0, 0, 0, 0, 0, 0,
0.625, -6.621478607310093e-11, 1.0053104257373267, -2.7461137687980931e-05, -1.0579872422220777, -0.0023356381000144777, 0.34242134824074066, -0.015197578088572708, -0.03770404436072726, -0.39999999992174173, -1.0443124698379609e-06, 1.2633470571572296, -0.00051050814445991019, -0.66150629468109079, -0.01312426059568563, 0.16810432080732068, -0.032202296007395423, 1.0833333333333333, -0.13333333333338038, 1.1910227438836859e-12, -1.1881932855392964e-11, 5.6744125053149475e-11, -1.397353413967518e-10, 1.7116173362394677e-10, -8.23933680777833e-11, 0, 0, 0, 0, 0, 0, 0, 0,
0.625, 0.39999999964042204, 5.2321213134510374e-06, -1.4214140795453845, 0.0026312681957924942, 1.1661679844969552, 0.071568826340610764, -0.62987255077351256, 0.1977767345985966, -5.9594777502747171e-10, 1.0053167497322559, -0.00025162392072370667, -1.4519159288068273, -0.021561138556163473, 0.88014572983072037, -0.14238441239126984, -0.1206680723733764, 1.0000000000000693, -0.25132741309424883, 2.8502288683870511e-08, 0.066146350277133087, 2.4134991744843042e-06, -0.0052311440108723959, 1.556616003277034e-05, 0.00018359849522279288, 0, 0, 0, 0, 0, 0, 0, 0,
0.625, 6.5755294018318932e-10, -0.85809392295122111, 0.44695095645788346, 1.1799189793631619, -0.56045091096201971, -0.71844932755014912, 0.48804298042988975, -0.037569303052609082, 0.34142135636952814, -0.17771621065643115, -1.1899362316964825, 0.60776743921485421, 0.9358991917287669, -0.44506500205948957, -0.37470863836003504, 0.21643018302460756, 0.85857864376287307, -0.1777153198206432, 0.11166190923505992, 0.0467717011512193, -0.01468680528747421, -0.0037197849815020895, 0.00082794328609200635, 8.1929185408994833e-05, 0, 0, 0, 0, 0, 0, 0, 0,
0.625, -0.20000000052364189, 0.25133360161313573, 0.63143566372857018, -0.85703121148766859, -0.35114405335909538, 0.69714178142379113, -0.050717896804424741, -0.11773359969388196, 3.5336635969017403e-10, -0.5026599203962091, 0.63184052359840792, 0.52661878314975619, -0.81347432532873465, -0.23618794393079146, 0.5522638571021603, -0.1627558313568177, 0.800000000000189, -2.4375333168245945e-09, 0.15791375793723023, -1.1761628950932283e-06, -0.020772692773716434, -2.9426243111086203e-05, 0.001155322325123458, -6.7733063464936672e-05, 0, 0, 0, 0, 0, 0, 0, 0,
0.625, 1.3842368879778906e-10, 0.14722316023541493, -0.44661452445314148, 0.12529026519658013, 0.58929141998853385, -0.28413624307106744, -0.29742732389043369, 0.18155894210916726, -0.058578644348091999, 0.17772287155290922, 0.073074433763625282, -0.60440724782008171, 0.24555580119961617, 0.53699835321500045, -0.39719796028089177, 0.040497895470823199, 0.85857864376277482, 0.17771531637336638, 0.11166186892707458, -0.046773364514636852, -0.0146902184811111, 0.0036781698048553332, 0.00080592943341187501, -0.00017771830546192509, 0, 0, 0, 0, 0, 0, 0, 0,
#endif
};

// The array of data is copy/pasted from the trajectory generator. Unfortunately it does not use the same
// order as in the firmware. Shuffle data around.
static void reorganizeData(float sequence[], int size) {
  int count = size / sizeof(float);
  const int perRow = 1 + 8 * 4;

  for (int i = 0; i < count / perRow; i++) {
    float* row = &sequence[i * perRow];
    float duration = row[0];

    for (int j = 0; j < 8 * 4; j++) {
      row[j] = row[j + 1];
    }

    row[8 * 4] = duration;
  }
}

void appInit() {
  if (isInit) {
    return;
  }

  timer = xTimerCreate("AppTimer", M2T(100), pdTRUE, NULL, appTimer);
  xTimerStart(timer, 100);

  pinMode(DECK_GPIO_IO3, INPUT_PULLUP);
  reorganizeData(sequence, sizeof(sequence));

  #ifdef USE_MELLINGER
  setControllerType(ControllerTypeMellinger);
  #endif

  commanderEnableHighLevel(true);
  crtpCommanderHighLevelDefineTrajectory(1, 0, sequence, sizeof(sequence));

  resetLockData();

  isInit = true;
}

static bool isButtonPressed() {
  return !digitalRead(DECK_GPIO_IO3);
}

enum State {
  STATE_IDLE = 0,
  STATE_WAIT_FOR_POSITION_LOCK,
  STATE_WAIT_FOR_TAKE_OFF,
  STATE_TAKING_OFF,
  STATE_GOING_TO_INITIAL_POSITION,
  STATE_RUNNING_TRAJECTORY,

  // Low battery states
  STATE_GOING_TO_PAD,
  STATE_LANDING,
  STATE_EXHAUSTED,
};

static enum State state = STATE_IDLE;

#define TAKE_OFF_HEIGHT 0.5
#define SEQUENCE_SPEED 1.0

static void appTimer(xTimerHandle timer) {
  if (isButtonPressed()) {
    if (! hasButtonBeenPressed) {
      hasButtonBeenPressed = true;
      ledseqRun(LED_LOCK, seq_armed);
    }
  }

  if (isBatLow() && (state > STATE_TAKING_OFF) && (state < STATE_GOING_TO_PAD)) {
    DEBUG_PRINT("Battery low, going to pad...\n");
    crtpCommanderHighLevelGoTo(0.7, -0.7, 0.4, 0.0, 2.0, false, 0);
    state = STATE_GOING_TO_PAD;
  }

  switch(state) {
    case STATE_IDLE:
      DEBUG_PRINT("Let's go! Waiting for position lock...\n");
      state = STATE_WAIT_FOR_POSITION_LOCK;
      break;
    case STATE_WAIT_FOR_POSITION_LOCK:
      if (hasLock()) {
        DEBUG_PRINT("Position lock acquired, ready for take off..\n");
        ledseqRun(LED_LOCK, seq_lps_lock);
        state = STATE_WAIT_FOR_TAKE_OFF;
      }
      break;
    case STATE_WAIT_FOR_TAKE_OFF:
      if (hasButtonBeenPressed) {
        DEBUG_PRINT("Taking off!\n");
        crtpCommanderHighLevelTakeOff(TAKE_OFF_HEIGHT, 1.0, 0);
        state = STATE_TAKING_OFF;
      }
      break;
    case STATE_TAKING_OFF:
      if (crtpCommanderHighLevelIsTrajectoryFinished()) {
        DEBUG_PRINT("Hovering, going to initial position...\n");
        ledseqStop(LED_LOCK, seq_lps_lock);
        ledseqStop(LED_LOCK, seq_armed);
        crtpCommanderHighLevelGoTo(sequence[0], sequence[8], sequence[16], sequence[24], 2.0, false, 0);
        state = STATE_GOING_TO_INITIAL_POSITION;
      }
      break;
    case STATE_GOING_TO_INITIAL_POSITION:
      if (crtpCommanderHighLevelIsTrajectoryFinished()) {
        DEBUG_PRINT("At initial position, starting trajectory...\n");
        crtpCommanderHighLevelStartTrajectory(1, SEQUENCE_SPEED, false, false, 0);
        state = STATE_RUNNING_TRAJECTORY;
      }
      break;
    case STATE_RUNNING_TRAJECTORY:
      if (crtpCommanderHighLevelIsTrajectoryFinished()) {
        DEBUG_PRINT("Trajectory finished, restarting...\n");
        crtpCommanderHighLevelStartTrajectory(1, SEQUENCE_SPEED, false, false, 0);
      }
      break;
    case STATE_GOING_TO_PAD:
      if (crtpCommanderHighLevelIsTrajectoryFinished()) {
        DEBUG_PRINT("At pad, landing...\n");
        crtpCommanderHighLevelLand(0.02, 1.0, 0);
        state = STATE_LANDING;
      }
      break;
    case STATE_LANDING:
      if (crtpCommanderHighLevelIsTrajectoryFinished()) {
        DEBUG_PRINT("Landed. Feed me!\n");
        crtpCommanderHighLevelStop();
        state = STATE_EXHAUSTED;
      }
      break;
    default:
      break;
  }
}


static bool hasLock() {
  bool result = false;

  // Store current state
  lockData[lockWriteIndex][0] = getVarPX();
  lockData[lockWriteIndex][1] = getVarPY();
  lockData[lockWriteIndex][2] = getVarPZ();

  lockWriteIndex++;
  if (lockWriteIndex >= LOCK_LENGTH) {
    lockWriteIndex = 0;
  }

  // Check if we have a lock
  int count = 0;

  float lXMax = FLT_MIN;
  float lYMax = FLT_MIN;
  float lZMax = FLT_MIN;

  float lXMin = FLT_MAX;
  float lYMin = FLT_MAX;
  float lZMin = FLT_MAX;

  for (int i = 0; i < LOCK_LENGTH; i++) {
    if (lockData[i][0] != FLT_MAX) {
      count++;

      lXMax = fmaxf(lXMax, lockData[i][0]);
      lYMax = fmaxf(lYMax, lockData[i][1]);
      lZMax = fmaxf(lZMax, lockData[i][2]);

      lXMin = fminf(lXMax, lockData[i][0]);
      lYMin = fminf(lYMin, lockData[i][1]);
      lZMin = fminf(lZMin, lockData[i][2]);
    }
  }

  // TODO krri Check that all anchors are received?

  result = (count >= LOCK_LENGTH) && ((lXMax - lXMin) < LOCK_THRESHOLD) && ((lYMax - lYMin) < LOCK_THRESHOLD) && ((lZMax - lZMin) < LOCK_THRESHOLD && sensorsAreCalibrated());
  return result;
}

static void resetLockData() {
    lockWriteIndex = 0;
    for (uint32_t i = 0; i < LOCK_LENGTH; i++) {
      lockData[i][0] = FLT_MAX;
      lockData[i][1] = FLT_MAX;
      lockData[i][2] = FLT_MAX;
    }
}
